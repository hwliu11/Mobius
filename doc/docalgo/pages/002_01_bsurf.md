B-spline surface {#bsurf}
=========================

# Control net

The following figure illustrates the indexation of a control
net for a B-surface \f$\textbf{s}(u,v)\f$:

\image html bsurf-control-net.png
\image latex bsurf-control-net.png

Internally, the control net is organized as a matrix represented by two nested
standard C++ vectors (std::vector). The rows of this matrix correspond to
isovalues in U direction. The cols in this matrix correspond to the isovalues
in V direction.

# Point inversion

\image html bsurf-invert-point.png
\image latex bsurf-invert-point.png

Point inversion is a fundamental algorithm which allows obtaining a preimage
of a 3D point in the parametric domain of a surface. In essence, point inversion
is equivalent to point projection. The mathematical formulation of the point
inversion problem is given in \ref piegl-tiller-1995 "The NURBS Book". The following
picture illustrates the poles of a control net projected to the B-surface using
the point inversion technique (the projected points are denoted with green color).

\image html bsurf-invert-poles.png
\image latex bsurf-invert-poles.png

There are some important points about the implementation of the Newton iterations
for point inversion.

- The search space is constrained with `U_min`, `U_max`, `V_min` and `U_max`
  extremities of a B-surface. If the next step of the Newton iteration falls
  outside the domain, the corresponding coordinate is snapped to its extremity.
  Without such a snapping, the values of the objective function may grow
  unexpectedly.

- If the search space is constrained as mentioned above, then the objective
  functions are often non-minimizable because they express the cosine whose
  values are sometimes geometrically constrained from being zeros (think of a border point
  whose projection cannot be orthogonal). In such circumstances, the algorithm
  cannot converge to the unconstrained minimum. Therefore, the stop criterion to
  use is not the value of a function (which should ideally become zero) but the
  step size in the search space.

\image html bsurf-invert-point-nonort.png
\image latex bsurf-invert-point-nonort.png

\todo describe and solve the inversion problem shown below

\image html bsurf-invert-poles-problem.png
\image latex bsurf-invert-poles-problem.png

An example of formally correct but unsuitable solution of point inversion is
shown in the figure below. Notice that intuitively we expect the projected
point lie as much close to the origin point as possible.

\image html bsurf-invert-poles-problem2.png
\image latex bsurf-invert-poles-problem2.png

# JSON dump

Mobius supports kernel-agnostic JSON-representations of B-surfaces. You can
obtain these dumps from \ref asitus2017 "Analysis Situs" interactively or
specify geometry manually (like this is done in mobius::test_BSplineSurface test
functions).

```
{
    entity: surface,
    type: b-surface,
    continuity: CN,
    domain: {
        U_min: 0,
        U_max: 10,
        V_min: -10,
        V_max: 0
    },
    flags: {
        is_U_rational: 0,
        is_V_rational: 0,
        is_U_periodic: 0,
        is_V_periodic: 0,
        is_U_closed: 0,
        is_V_closed: 0
    },
    properties: {
        U_degree: 1,
        V_degree: 1,
        U_knots: [0, 0, 10, 10],
        V_knots: [-10, -10, 0, 0],
        num_poles_in_U_axis: 2,
        num_poles_in_V_axis: 2,
        poles: {
            u0: [[0, 10, 0], [0, 0, 0]],
            u1: [[0, 10, 10], [0, 0, 10]]
        }
    }
}
```
