//-----------------------------------------------------------------------------
// Created on: 15 June 2018
//-----------------------------------------------------------------------------
// Copyright (c) 2013-present, Sergey Slyadnev
// All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are met:
//
//    * Redistributions of source code must retain the above copyright
//      notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above copyright
//      notice, this list of conditions and the following disclaimer in the
//      documentation and/or other materials provided with the distribution.
//    * Neither the name of Sergey Slyadnev nor the
//      names of all contributors may be used to endorse or promote products
//      derived from this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
// ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
// WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
// DISCLAIMED. IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE FOR ANY
// DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
// (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
// LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
// ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//-----------------------------------------------------------------------------

// Own include
#include <mobius/test_BSplineSurface.h>

// geom includes
#include <mobius/geom_BSplineSurface.h>

//-----------------------------------------------------------------------------

//! Test scenario 001: evaluate B-surface in its domain.
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalInDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // Control points.
  std::vector< std::vector<xyz> >
    Q = { { xyz(0.0, 0.0, 0.0), xyz(0.0, 1.0, 0.0) },
          { xyz(1.0, 0.0, 0.0), xyz(1.0, 1.0, 0.0) },
          { xyz(2.0, 0.0, 0.0), xyz(2.0, 1.0, 0.0) } };

  // Knot vectors.
  const std::vector<double> U = {0, 0, 0.5, 1, 1};
  const std::vector<double> V = {0, 0, 1, 1};

  // Degrees.
  const int p = 1;
  const int q = 1;

  // Construct B-surface.
  core_Ptr<bsurf> surf = new bsurf(Q, U, V, p, q);

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 0.5;
  const double v   = 0.5;
  //
  const xyz P_ref(1, 0.5, 0);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Test scenario 002: evaluate B-surface out of its domain.
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalOutDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // Control points.
  std::vector< std::vector<xyz> >
    Q = { { xyz(0.0, 0.0, 0.0), xyz(0.0, 1.0, 0.0) },
          { xyz(1.0, 0.0, 0.0), xyz(1.0, 1.0, 0.0) },
          { xyz(2.0, 0.0, 0.0), xyz(2.0, 1.0, 0.0) } };

  // Knot vectors.
  const std::vector<double> U = {0, 0, 0.5, 1, 1};
  const std::vector<double> V = {0, 0, 1, 1};

  // Degrees.
  const int p = 1;
  const int q = 1;

  // Construct B-surface.
  core_Ptr<bsurf> surf = new bsurf(Q, U, V, p, q);

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 1.5;
  const double v   = 1.5;
  //
  const xyz P_ref(3, 1.5, 0);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object.
//!
//! The surface is C0-continuous. It is evaluated in the middle point.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalJSON1(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C0,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 1,\
        V_degree: 1,\
        U_knots: [0, 0, 0.5, 1, 1],\
        V_knots: [0, 0, 0.5, 1, 1],\
        num_poles_in_U_axis: 3,\
        num_poles_in_V_axis: 3,\
        poles: {\
            u0: [[-10, -10, 0], [-10, 0, 0], [-10, 10, 0]],\
            u1: [[0, -10, 0], [0, 0, 10], [0, 10, 0]],\
            u2: [[10, -10, 0], [10, 0, 0], [10, 10, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 0.5;
  const double v   = 0.5;
  //
  const xyz P_ref(0, 0, 10);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object.
//!
//! The surface has irregular parameterization near the max value of its curvilinear
//! coordinate V = V_max = 5.1866714434994.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalJSON2(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 0.95031615985331297,\
        V_min: 2.7739444971105378,\
        V_max: 5.2866714434994\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.15215133237491321, 0.30430266474982642, 0.45645399712473961, 0.60860532949965274, 0.77946074467648285, 0.95031615985331297, 0.95031615985331297, 0.95031615985331297, 0.95031615985331297],\
        V_knots: [2.7739444971105378, 2.7739444971105378, 2.7739444971105378, 2.7739444971105378, 2.973752686968413, 3.3041696521871251, 3.6345866174058381, 3.9650035826245502, 4.2954205478432623, 4.6258375130619749, 4.9562544782806874, 5.2866714434994, 5.2866714434994, 5.2866714434994, 5.2866714434994],\
        num_poles_in_U_axis: 9,\
        num_poles_in_V_axis: 11,\
        poles: {\
            u0: [[2798.9455164305973, -564.0107501072988, 712.92358035843279], [2866.0958153498605, -566.86516373773884, 711.34840943413406], [3044.2739190469856, -574.94375338520831, 707.12535142508989], [3333.4582744417507, -590.77166362188404, 700.24959668275471], [3665.75713302945, -615.4012941362887, 692.74829403468834], [3998.0229949721997, -648.56699700760407, 686.12506726381753], [4327.4999409546645, -693.43081146947407, 681.52830937981673], [4661.1563125334014, -750.31560089700122, 678.88560100063648], [4960.9120004544548, -855.80928469976186, 686.86268394446665], [5202.6229458470998, -955.68640583188539, 697.50617166126085], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u1: [[2786.8032191605867, -601.09010925355085, 737.9883753135864], [2853.6862794525396, -603.61586285919668, 736.39954051909626], [3031.1574666274264, -610.76173505354575, 732.09513676350753], [3319.028061794223, -624.70616329027621, 724.65478882371872], [3649.9008054113278, -646.38997073254473, 715.68417576931927], [3980.7179363613009, -675.79323128853287, 706.69867073930311], [4309.3170277177051, -716.07548473598888, 698.7806474262444], [4640.6919327410287, -768.13341091857865, 692.03249720688825], [4946.8731591764517, -864.23243353942007, 693.97043948367059], [5178.6558879397608, -960.65911221900387, 701.16669661190952], [5229.8220700325737, -1058.8898967817131, 716.93503449971024]],\
            u2: [[2766.4247543998681, -678.35402023972233, 782.94313479641835], [2832.8601423019977, -680.25817991944859, 781.3189750193975], [3009.1473982313923, -685.6415474059329, 776.84414655063972], [3294.8176626522259, -696.04493646813637, 768.39337717894284], [3623.3108764124177, -712.19483039757267, 756.86139775672586], [3951.7278552909452, -734.45729805037104, 743.77658160836609], [4278.8660407789739, -765.85620379368913, 730.07672949814685], [4606.5177632392015, -808.13530287791457, 716.128098039007], [4923.3883811287624, -885.55311888792244, 707.37267375445549], [5139.302721776191, -972.49694693112633, 707.97292451189492], [5229.8220700325746, -1058.8898967817131, 716.93503449971013]],\
            u3: [[2747.5754465966966, -801.74639499791306, 837.54568985917638], [2813.5997405084795, -802.87355870592353, 835.77311925601578], [2988.8008049665841, -806.04991056540212, 830.82989803882879], [3272.4521423984033, -812.02720047507239, 820.91211099729503], [3598.7941616260487, -821.18862491009565, 806.31547218029459], [3925.1028421397377, -834.1313812710174, 788.60305237665568], [4250.9340789764474, -853.28379131270958, 768.45819007595753], [4575.5202792352102, -880.75855080443625, 746.38567090124025], [4901.9399275821797, -930.71810703772303, 725.39056791537087], [5106.0020356223267, -995.8789437426816, 716.62801515356739], [5229.8220700325737, -1058.8898967817131, 716.93503449971001]],\
            u4: [[2740.4445281314324, -934.41465101791846, 871.60774362345023], [2806.3181426472593, -934.87304933526252, 869.79572560675138], [2981.1227210310235, -936.153968381911, 864.71373114846006], [3264.0367006037541, -938.38746584318721, 854.2579045221712], [3589.64562555168, -941.63883870512734, 838.38796173049457], [3915.3379374428591, -946.41937898357492, 818.58326655697806], [4240.7466357794901, -954.16983632471704, 795.23509233422897], [4564.786565479968, -966.4701744254869, 768.72948485119741], [4894.2701875605471, -989.30103816807582, 740.30903956785914], [5098.4665457017927, -1024.891542423996, 723.72612091198084], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u5: [[2745.2199794700018, -1079.8475752233953, 889.71246336390254], [2811.2078257956427, -1079.7841667307814, 887.86601406621128], [2986.317638729231, -1079.5800579820927, 882.69928518864424], [3269.7981296791322, -1078.892369445131, 872.19041039523245], [3596.1201300409402, -1077.4202026996149, 856.32993176465493], [3922.7238808573397, -1075.215069709604, 836.45662901293292], [4248.6133769267626, -1072.281586679879, 812.6185986497627], [4574.7071344169717, -1068.7065351464989, 784.81047010509008], [4900.6294880342921, -1063.946207398111, 753.14221248495573], [5117.4230174915965, -1060.8929598624311, 729.48318711103423], [5229.8220700325746, -1058.8898967817131, 716.93503449971013]],\
            u6: [[2763.641472566735, -1236.8672900609779, 878.32734964323595], [2830.0471221669159, -1236.5128225990291, 876.74552892021154], [3006.2662815759954, -1235.4600587356158, 872.33440719685848], [3291.807410503935, -1233.0667841399429, 863.59225830802131], [3620.4991822808229, -1228.5536562654361, 850.66845400685361], [3949.7636663509697, -1221.0471988772299, 834.50510116516091], [4277.1685928886536, -1208.609134049341, 814.7504254086482], [4608.2902759889994, -1188.738751843091, 790.69677003169159], [4923.0633696314799, -1156.3096283152222, 762.05145347335235], [5166.7407778915504, -1104.5180234720119, 733.61972813707234], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u7: [[2786.2386397869227, -1347.7882860844377, 852.88494299262015], [2853.152291179128, -1347.4697580816623, 851.5857089173553], [3030.7188246609157, -1346.480076491978, 847.99542478459432], [3318.763090566038, -1344.110613452445, 841.29061329374701], [3650.2866682587924, -1339.1259816890299, 831.94376328058513], [3982.6463439074778, -1329.6505165273279, 820.5178260704746], [4311.8432986449779, -1312.0720624764849, 806.35273964433884], [4648.5616873057506, -1281.3415942363999, 788.03865190698434], [4950.1687797359164, -1230.771068469166, 765.57124495607832], [5222.5199717803953, -1139.2022947231969, 735.12273257278275], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u8: [[2799.9999865623431, -1401.9166801004526, 833.9211672781546], [2867.2223681697769, -1401.7258489284618, 832.83717033423216], [3045.60753873161, -1401.0640106744295, 829.86203204549713], [3335.1727105876639, -1399.2245059146978, 824.59098851264946], [3668.410222389793, -1394.6622793516422, 817.66231991812504], [4002.6310411514191, -1384.877086509435, 809.39114981582463], [4332.9098796233584, -1365.33744331056, 798.95536965762994], [4672.9560726785676, -1329.5306692263059, 784.53996145231145], [4966.6172503371636, -1270.390219343657, 766.42653008969262], [5255.8298617696564, -1157.573034130799, 735.51290549326927], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test 1.
  {
    const double u = 0.5;
    const double v = 3;
    //
    const xyz P_ref(2966.1562033533373, -975.99025344537256, 868.77888598126765);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 2.
  {
    const double u = 0.5;
    const double v = 5;
    //
    const xyz P_ref(4936.6672840131978, -1017.8903156478241, 740.14824482133531);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 3.
  {
    const double u = 0.95031615985331297; // U_max.
    const double v = 5.2866714434994; // V_max.
    //
    const xyz P_ref(5229.8220700325737, -1058.8898967817131, 716.93503449971013);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 4.
  {
    const double u = 0.96; // > U_max.
    const double v = 5.29; // > V_max.
    //
    const xyz P_ref(5228.8089992117957, -1055.7995537824584, 716.37072890072977);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 1-order derivatives.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD1InDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =\
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.14586638621970127, 0.2145640793417587, 0.28307649700999143, 0.34996357207739526, 0.41516162276667518, 0.47821415292419189, 0.54127862619453604, 0.60512428633496806, 0.67470436020123181, 0.74578847214124, 0.81993610554425811, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.14690393242688526, 0.21591144963334422, 0.27704495964889098, 0.3376769446215917, 0.39825108338441551, 0.4583896064467492, 0.52236780332771982, 0.58777285300797455, 0.65458567968353609, 0.7187379588367051, 0.80067148846068914, 1, 1, 1, 1],\
        num_poles_in_U_axis: 15,\
        num_poles_in_V_axis: 15,\
        poles: {\
            u0: [[62.480551458144582, 179.59308573281325, 672.92900658560268], [64.317217499564052, 177.23078342228092, 670.17435680279425], [67.04648849676849, 173.73923792479147, 666.11982934937032], [70.730872244632806, 169.24404869700589, 661.09709386440318], [73.456489438060544, 166.15437307556587, 657.86827443651271], [76.205765087612718, 163.20781001261861, 654.96236681450307], [79.130113652253058, 160.28986095816941, 652.31800724649338], [82.221159974821148, 157.32645186673739, 649.77253449217142], [85.509793040640446, 154.29472882160101, 647.31447126139881], [88.981708802716454, 151.16180402245104, 644.85935709837008], [92.486942182661465, 148.02856022064697, 642.44211276052522], [96.305553390170232, 144.63308281091346, 639.84570037503988], [102.50306901565294, 139.1242458186187, 635.63579611045043], [107.54141936773664, 134.63791838675789, 632.19709406636912], [111.08691458693504, 131.45678236776106, 629.72750266643754]],\
            u1: [[63.696644326691001, 182.59652276387791, 670.8054348291605], [65.528119976522973, 180.2337860721652, 668.04388578237536], [68.283052335246495, 176.74438816071495, 664.02346837713196], [72.041026907032133, 172.25535771082488, 659.09855258686468], [74.859825125180436, 169.17348036102845, 655.99359288638016], [77.696251927222548, 166.23421093284341, 653.20352985850548], [80.700297017942304, 163.32293163933801, 650.66510591446024], [83.84618595210361, 160.36411229763306, 648.19253202492462], [87.18998064223149, 157.3370057002326, 645.80779170265635], [90.681603656665388, 154.20573019081405, 643.37887316166916], [94.203255243239525, 151.07386042020963, 640.98345252241165], [98.023468896131405, 147.67851711829931, 638.38917016767709], [104.23297359763245, 142.17068348556012, 634.19520223446159], [109.26027581522747, 137.68343144105208, 630.74181459392605], [112.80250429085561, 134.50202202998011, 628.26788091540959]],\
            u2: [[65.485528565981184, 187.01935960661012, 667.67551513978037], [67.345642867551575, 184.65901966881233, 664.95203366746273], [70.091478342952385, 181.16886044391333, 660.91952434230313], [74.082958373383505, 176.69937194478132, 656.30499280185086], [77.027082498297645, 173.62798305513724, 653.36662101660545], [80.0007177965295, 170.70019653485369, 650.75894068935929], [83.091407372260079, 167.79616847337175, 648.33568785795444], [86.316396559813185, 164.843968990859, 645.96825700426734], [89.698907457498635, 161.82010253279401, 643.63497972320022], [93.209415055240058, 158.69040746436022, 641.23116328156561], [96.738098886714411, 155.55912621868526, 638.84509016707295], [100.57090828163808, 152.16483704789448, 636.26755054702869], [106.77204925091898, 146.6563034587428, 632.06246522594938], [111.79916110445876, 142.16903548276571, 628.60882454634611], [115.34115417332147, 138.98760637062347, 626.13457795629097]],\
            u3: [[67.904173632790631, 192.86808069567635, 663.61276076657646], [69.798544510667014, 190.5106076729862, 660.93481442564257], [72.708007303179926, 187.03414233341334, 657.11980469284697], [76.97618928969051, 182.58781087751032, 652.87307581344623], [80.073527850790484, 179.52924442458695, 650.13836242707816], [83.177763987639594, 176.61238782076833, 647.70428165315184], [86.350587119790731, 173.71523347403567, 645.39020383821946], [89.637399285491966, 170.76820792450735, 643.1049504154405], [93.034370902796311, 167.74555167656911, 640.79089486750013], [96.565148997649914, 164.61755303552843, 638.41402273404822], [100.10447837781695, 161.48716271030335, 636.04210008380801], [103.93221075393043, 158.09244864644114, 633.45781189914794], [110.13246072472874, 152.58384049008757, 629.25154222933509], [115.14109605956334, 148.0950262238411, 625.77334186520818], [118.67834409327438, 144.91320000216729, 623.29278799572637]],\
            u4: [[69.691275710741337, 197.09210513567584, 660.7365357308696], [71.620662330082695, 194.73756256223291, 658.10513363223674], [74.692223654473025, 191.2746631647417, 654.50559137290247], [79.149415899825087, 186.8441498793961, 650.51010204797387], [82.342262303134021, 183.79357642826443, 647.90234128244629], [85.521780025763817, 180.88302010132483, 645.56832762756119], [88.739623550655367, 177.98963348791679, 643.31409261420004], [92.044143458921511, 175.04408989018214, 641.05237698973724], [95.458001893980182, 172.02284689126594, 638.7607680359431], [98.994619915828665, 168.89533699068667, 636.39165855339115], [102.53068879969564, 165.76467379621755, 634.01540192867355], [106.36400439303873, 162.3704269889094, 631.43853516662955], [112.54689858661972, 156.86036633656173, 627.20919554408954], [117.56899425799146, 152.37267855889891, 623.74888716622957], [121.09471256788834, 149.18988742061794, 621.25300755362457]],\
            u5: [[71.506127463688586, 201.25187894769059, 657.98300470566437], [73.518446409089023, 198.90427693761367, 655.46183937819308], [76.758191585647779, 195.45545275950354, 652.08585342922242], [81.35511482445699, 191.03663348854801, 648.27609980329203], [84.631120864347935, 187.99301962428189, 645.77887795862682], [87.861359260024869, 185.08670808417025, 643.51228413258116], [91.103226729212182, 182.1953320222037, 641.2899826507537], [94.428519203883667, 179.25152686978026, 639.05587870388672], [97.846172713164378, 176.23060147865738, 636.76931430567424], [101.38743541488202, 173.10348028892918, 634.40637870653359], [104.92595349624649, 169.97302206652731, 632.03337764736875], [108.74989485388342, 166.57799073429521, 629.44405029817494], [114.9474219302368, 161.06915470031663, 625.23416125451377], [119.93498376408989, 156.57857680370105, 621.72794919922592], [123.45887471163971, 153.39563273441172, 619.22964058776802]],\
            u6: [[73.346923162589064, 205.30707998653847, 655.40154519609678], [75.456474961894429, 202.96761534358737, 653.00962543997696], [78.838951494464737, 199.5307362786547, 649.82336338490734], [83.562144311634881, 195.12248444323782, 646.18145203804102], [86.901557671947401, 192.08417710474072, 643.76851359170337], [90.161895231630353, 189.18038454805762, 641.5419287080324], [93.42023820513684, 186.29038731250438, 639.3415270870421], [96.752066891229603, 183.34712917222586, 637.11611131855841], [100.17929397465781, 180.32700498855979, 634.84227247566002], [103.71983523845637, 177.19982342206529, 632.47837791406562], [107.25544315198827, 174.06912164922761, 630.10150855021664], [111.08070622383289, 170.67420093057103, 627.51393807332613], [117.2451944287812, 165.16259989057758, 623.26013251749907], [122.26189054537653, 160.67446022697598, 619.79264684807185], [125.77145365260883, 157.49031706816061, 617.27529313165667]],\
            u7: [[75.236428625634133, 209.29174980044704, 652.98099687099989], [77.439675725012478, 206.96012646857685, 650.71362043644854], [80.951054221658183, 203.53403514217834, 647.69869972667902], [85.768919629533656, 199.13370640678937, 644.18263075289599], [89.156623019963561, 196.09944043587299, 641.83388123326836], [92.42700306747318, 193.19648832978922, 639.62064520263323], [95.701706828122454, 190.30786032002877, 637.44199095608565], [99.041993003974056, 187.36530998268231, 635.22781720151204], [102.46383513512129, 184.34473513515212, 632.94682047723643], [106.00800715079268, 181.21785742439957, 630.58775204777032], [109.53843065715368, 178.08672177121372, 628.20399137465711], [113.35634222319324, 174.69118580884825, 625.60664899938206], [119.54055940478547, 169.18123587667992, 621.37906794233083], [124.51323334809739, 164.68941202022322, 617.85306634223662], [128.02259008433253, 161.50525159032574, 615.33543830971632]],\
            u8: [[77.190399348404284, 213.25588919114713, 650.67955440601543], [79.482004991560927, 210.93166053999005, 648.52962747557524], [83.103052053817663, 207.51474731898335, 645.66048235350672], [87.9939969943553, 203.12053457178916, 642.24155344682924], [91.405585938410681, 200.0882675704708, 639.92455350464706], [94.693264905049787, 197.18676320195911, 637.73431184882384], [97.973239114537023, 194.29857627332888, 635.56266328136462], [101.31628347252509, 191.35625676681565, 633.35215580636452], [104.74547804048053, 188.3362972409096, 631.08093221799857], [108.27858617173061, 185.20849359940627, 628.70715725667674], [111.81553212297091, 182.07790380625045, 626.33206646294218], [115.62401630227028, 178.68157887077714, 623.72219285016206], [121.79166458432206, 173.1702422959975, 619.47258778783146], [126.76843636814165, 168.67876138568815, 615.9520331916699], [130.27041202403959, 165.49398323700439, 613.4245939491833]],\
            u9: [[79.287141939825659, 217.36335002519314, 648.39855880499692], [81.665264209750646, 215.04636190567075, 646.36363303320979], [85.37537445834765, 211.63690233654651, 643.61287405268354], [90.318066870426193, 207.24702030841445, 640.26272983406966], [93.747725111685483, 204.21626551720959, 637.96974828224916], [97.043566753161116, 201.31544427872234, 635.79035676123726], [100.33076777325391, 198.42786215812475, 633.62831434260897], [103.67468630290277, 195.48561581058433, 631.41896884950245], [107.09523005640196, 192.46493230250212, 629.1362462727584], [110.63687961188853, 189.33784348836434, 626.77382489421393], [114.15237199266522, 186.20545825702058, 624.37021720664598], [117.97182879496231, 182.81005161467633, 621.77492881759883], [124.12211323889406, 177.29726186928789, 617.50224308769214], [129.09103100474908, 172.80512366028739, 613.97124863505462], [132.58067246793897, 169.61931326941152, 611.42741431909621]],\
            u10: [[81.54457332594302, 221.64517702306975, 646.12374406552522], [83.993045158655562, 219.33407642197889, 644.18232958207113], [87.785844227572582, 215.9315370373528, 641.54148369570476], [92.748315309012511, 211.54331027580324, 638.21763002930129], [96.194788267656165, 208.51396269957797, 635.94699923309713], [99.500452053151818, 205.61396347123068, 633.78066367583426], [102.78329028743745, 202.72601623135088, 631.61282207800048], [106.12892004882914, 199.78391309590802, 629.40575121857501], [109.55046507558056, 196.76331338386476, 627.12435957194634], [113.07640959151435, 193.63491022311035, 624.7410624633535], [116.60717977088476, 190.50380358280881, 622.3577626010607], [120.40881254780352, 187.10690525702313, 619.73878184620082], [126.54862887701739, 181.59323944054162, 615.45218150396465], [131.51028869718917, 177.10049381783037, 611.91153951657998], [134.9903273935401, 173.91387977637694, 609.3549408412847]],\
            u11: [[83.98121356904376, 226.14837070780354, 643.82114500094656], [86.50643085191642, 223.84369289364264, 641.98174346019755], [90.328552940761114, 220.44360753735032, 639.37987483627137], [95.321490819616514, 216.05793052627843, 636.09651878441991], [98.774795127007025, 213.02915466208759, 633.83496847424829], [102.07872360880604, 210.1290102070738, 631.66632628595835], [105.36998814281783, 207.2417681598491, 629.5096852430687], [108.70487887504655, 204.29876628062377, 627.2883396616312], [112.12905987993805, 201.27838717222428, 625.01045185642113], [115.6547483182657, 198.14996258046796, 622.62681435982961], [119.17151050257338, 195.01768361832296, 620.22489454293702], [122.96406794818193, 191.62002578276545, 617.59385051590846], [129.10223135078868, 186.10622163371377, 613.30505304137262], [134.03578682652181, 181.61112397298822, 609.72705370090887], [137.51250071496216, 178.42423168008526, 607.16603556571965]],\
            u12: [[87.757093160722803, 232.97493490908371, 640.44850892783495], [90.344583276407505, 230.67546867601158, 638.69188278175409], [94.215483708371977, 227.27946555396139, 636.15485216857053], [99.227139514904621, 222.89535503655216, 632.89637669113415], [102.68937196211233, 219.86732636375308, 630.64669400065623], [105.99903694466801, 216.96766199351313, 628.48567698521776], [109.28026656252911, 214.0795801293587, 626.31569715384978], [112.62142132457781, 211.13710248354164, 624.10267795676066], [116.02120488128818, 208.11468156535403, 621.79236014458456], [119.54932799722351, 204.98646073050392, 619.41195891316102], [123.04833441542566, 201.85269579750076, 616.98643746325035], [126.84999031857963, 198.45579940713722, 614.36748744865395], [132.931993392565, 192.93729522930326, 610.00403955023103], [137.88349112575921, 188.44369914680175, 606.44988973411398], [141.32655440641395, 185.25399065198113, 603.84414194372323]],\
            u13: [[90.785755383573161, 238.31619883682606, 637.91649309178729], [93.394896703119173, 236.01854458177831, 636.18864654129675], [97.279317054757087, 232.62367293479653, 633.66958711452469], [102.29912678166019, 228.24024481475391, 630.42195013513322], [105.75878834228514, 225.21200098579047, 628.16885012538739], [109.05986583107955, 222.31161793265005, 625.99641828981976], [112.34017984447405, 219.42345944203311, 623.82522140251319], [115.65918196811879, 216.47912785339341, 621.58275608415602], [119.08498868279067, 213.45888479980289, 619.3070292336123], [122.58164101733202, 210.32803019157663, 616.88479585432344], [126.09401031345001, 207.19538359089591, 614.47703684500675], [129.84515274908676, 203.79425975462937, 611.79094242696704], [135.96928530728385, 198.2792813714826, 607.48349462562157], [140.83451066196145, 193.77846519835819, 603.81466831482805], [144.29761270438041, 190.59043373711879, 601.23555680126515]],\
            u14: [[92.94233193702668, 242.10042723092349, 636.13811021161246], [95.561920411489851, 239.80364729285392, 634.42415041289416], [99.453566608437569, 236.40938037311847, 631.9146958518445], [104.47245803928998, 232.02587540135636, 628.66583823875953], [107.92913964626121, 228.99738218161608, 626.40877716238526], [111.2310379114887, 226.09706781883031, 624.23743633376694], [114.50420999309833, 223.20831162364524, 622.05674612175403], [117.83244229617613, 220.26475250393668, 619.82654990552226], [121.23231276266567, 217.24233885918386, 617.51634761709533], [124.738447303109, 214.11227781185249, 615.10671834300638], [128.2262618779759, 210.97757623928342, 612.66632027343087], [131.99137335650968, 207.57762146497259, 609.99879403330874], [138.07148814740987, 202.05895925770594, 605.63283615789226], [142.95882995175077, 197.55999399878513, 601.99340786493224], [146.39227476974759, 194.36948053981192, 599.37487485172937]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 0.5;
    const double v = 0.5;
    //
    const xyz P_ref  (102.01056087867869, 186.81000791347395, 633.12859242907416);
    const xyz dU_ref (35.950281444623457, 63.027026776358525, -29.57316833575419);
    const xyz dV_ref (54.198526472252823, -47.810554718737549, -36.061975169786187);

    // Evaluate.
    xyz P, dU, dV;
    surf->Eval_D1(u, v, P, dU, dV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 1-order derivatives
//! out of its parametric domain.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD1OutDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 1,\
        U_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\
        V_knots: [0, 0, 1, 1],\
        num_poles_in_U_axis: 6,\
        num_poles_in_V_axis: 2,\
        poles: {\
            u0: [[241.87747035573125, 62.485923112593042, 0], [307.49011857707512, 49.837701768719491, 0]],\
            u1: [[245.29391602546553, 57.035146252318057, 0], [306.57174310419981, 45.021517271473421, 0]],\
            u2: [[250.62433050286035, 49.413132207145885, 25], [303.8174241480333, 37.906450425886014, 0]],\
            u3: [[260.43129359394032, 37.406082628166004, -22], [295.65540308364263, 29.098297811030434, -30]],\
            u4: [[266.65853554251112, 30.811365428505532, 0], [288.81855843279288, 26.561552469297354, 0]],\
            u5: [[271.12648221343875, 26.517543665952715, 0], [284.16996047430831, 25.727029831960614, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 1.1; // Out of range
    const double v = 1.1; // Out of range
    //
    const xyz P_ref  (281.32712540796518, 25.457981859438284, -4.6248038997486107);
    const xyz dU_ref (-41.09642504354224, -0.19347502194278832, -99.247529960069542);
    const xyz dV_ref (6.1947345560560407, 1.9242835963289397, -1.0971603699159702);

    // Evaluate.
    xyz P, dU, dV;
    surf->Eval_D1(u, v, P, dU, dV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 2-order derivatives.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD2InDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C3,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 4,\
        V_degree: 6,\
        U_knots: [0, 0, 0, 0, 0, 0.206392961480693, 0.29068747464739936, 0.37478665622968027, 0.45843065841149361, 0.54193027126411775, 0.62497941754339359, 0.70808932166508454, 0.79129395135668346, 1, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0, 0, 0, 0.23031026431400881, 0.28839397730608679, 0.34529326822772871, 0.4015964749653777, 0.45824315522017756, 0.51626394341957227, 0.57449586388738816, 0.63468555729632492, 0.69890042086688409, 1, 1, 1, 1, 1, 1, 1],\
        num_poles_in_U_axis: 13,\
        num_poles_in_V_axis: 16,\
        poles: {\
            u0: [[-62.662010160417445, 341.19642674033247, 651.90482970001995], [-60.619909862716064, 342.7984566736049, 654.48988105505339], [-57.972793198183631, 344.7847928078055, 657.6098061516218], [-54.85481118739164, 347.25183078712519, 661.61044020172631], [-50.923047771204111, 350.06039782539074, 665.88199251071092], [-46.221511821011021, 353.30903885406519, 670.70905766059082], [-40.467358585829551, 356.88648561789097, 675.59768022197704], [-36.436622214762295, 359.22407556970171, 678.59151112216443], [-32.139815495048666, 361.47174273601479, 681.15839311167827], [-27.584109030277109, 363.68866695650968, 683.45497767710401], [-19.575968659728812, 367.25142282810384, 686.63728286106971], [-11.940946043520681, 370.27397637382984, 688.71434860478519], [-5.4984238567094268, 372.4929647602533, 689.61930083164998], [-1.1999135395521472, 374.4794880482051, 691.51708905278338], [4.5010472266249408, 375.27339081138632, 689.32663704524282], [8.020645266084566, 375.93473481025666, 688.41216789152509]],\
            u1: [[-61.979433202339052, 338.36816854761429, 653.38499257149795], [-60.049754822021136, 340.03046888798178, 656.20740756515863], [-57.132437561037229, 341.87194803766431, 658.75684073073637], [-54.366359859424705, 344.52764510115679, 663.50047302551673], [-50.052739638607683, 347.13149525141665, 666.96578645601596], [-45.609113816222873, 350.51840423318669, 672.33739387848902], [-39.640026884696567, 353.98062309766919, 676.77221307642742], [-35.650914601471285, 356.34052809959059, 679.85392759553656], [-31.272708367120941, 358.54455624959638, 682.24894554440505], [-26.725685959830827, 360.76613607188227, 684.56386531999215], [-18.634969360601794, 364.28462208012303, 687.57182199111151], [-10.944300966335209, 367.27734342075058, 689.53139921781963], [-4.6392579111010415, 369.57003561351979, 690.72661999430215], [-0.024366724136580992, 371.38694425455145, 691.95641289746538], [5.388431655135375, 372.33533348064827, 690.37437670652469], [9.2769028893552523, 372.79892122222333, 688.6810818065195]],\
            u2: [[-61.030726468158271, 334.39469129525219, 655.49269036215549], [-58.64777829368925, 335.8139895978004, 657.35808763069315], [-56.819885265903856, 338.2395189359998, 662.20769238239575], [-52.75058942396371, 340.19654896293878, 664.19975623801542], [-49.552861761955278, 343.39863921058912, 670.02112553615791], [-44.28183602327632, 346.34197161089082, 673.64579019760197], [-38.698800805986359, 350.0111562923916, 678.8957052570405], [-34.426128768664462, 352.21904234446851, 681.37872179468673], [-30.163130365550547, 354.48483445521583, 684.01698546165835], [-25.441598691844987, 356.61285828079895, 685.96345257765245], [-17.370715553845901, 360.14197718706441, 689.01328491356662], [-9.5802111411851971, 363.08117553489484, 690.76207192112327], [-3.2199131064089945, 365.34424503320855, 691.84062929877507], [1.3523788361292581, 367.18399151457595, 693.16036473163558], [7.5258601090621591, 367.72457175870483, 689.97224972898857], [11.048489289026833, 368.38429073571587, 689.05138073294518]],\
            u3: [[-59.806396315495228, 329.2726015860934, 658.20586610313785], [-58.105963474727737, 331.0578025344409, 661.51230197709674], [-54.728704463754553, 332.65270275037466, 663.09063048714597], [-52.281933638640801, 335.47958311946246, 668.50843596651964], [-47.700045405072807, 337.93961236078729, 671.40733785442762], [-43.243876043447735, 341.31979663766748, 676.75246129421885], [-37.133503545376847, 344.70627103156733, 680.88897517103908], [-33.013550503769324, 346.99603111906259, 683.69443716558283], [-28.514742157548458, 349.1354033856756, 685.83482010404066], [-23.841935186762804, 351.28954896536646, 687.88416282514447], [-15.594458987342914, 354.72399473356836, 690.5611428507741], [-7.8815482077915382, 357.70479173020101, 692.47375829611087], [-1.255275575859454, 359.82526984038111, 692.99074636727016], [2.5830802612180292, 362.05848610865883, 695.86008839463682], [11.25730639153206, 361.25839440775138, 687.39198962612522], [13.360713972859077, 362.67897092504722, 689.46761464619362]],\
            u4: [[-58.319791766562254, 323.01953045612368, 661.5402773564175], [-56.055103771017784, 324.50222911060132, 663.65536496140828], [-53.877213219636545, 326.74012160963616, 667.7659973876772], [-50.171889404746565, 328.89228033348741, 670.52653883839673], [-46.453051481414327, 331.81499865502059, 675.24765446139827], [-41.414949072188421, 334.88320335973992, 679.36410515792613], [-35.393417392457863, 338.31730612017873, 683.68819437943705], [-31.084836949925105, 340.50594135132309, 686.09539518722522], [-26.606359422487724, 342.65621315384612, 688.27870389350119], [-21.815157619668618, 344.74688619283273, 690.07807197635191], [-13.531809676431322, 348.16210079461274, 692.67931367768915], [-5.531642535941371, 350.98889705701026, 693.9854262573142], [0.25944681718789347, 353.55712447979693, 696.26579060437052], [6.831844205658764, 354.3245963344944, 693.36257452222094], [12.643833145578848, 355.05897588916969, 690.93770157679774], [16.223770657051535, 355.68797135112385, 689.89583380752856]],\
            u5: [[-57.227891477090594, 318.44398987148202, 663.96885936864226], [-55.298920421522332, 320.10666941505838, 666.79276778265864], [-52.388434830419605, 321.95181108475498, 669.35662509302108], [-49.25346178328963, 324.40974001574551, 673.32138487321004], [-45.187992308743873, 327.14662602635303, 677.31063496513434], [-40.178224157805445, 330.230020983293, 681.48690960706278], [-34.079904194086467, 333.62295684990795, 685.64887077633216], [-29.707864795264573, 335.77757116040232, 687.92208660040387], [-25.167297286383548, 337.89455596207785, 689.97430072777559], [-20.310395416851442, 339.95000660084168, 691.63495202604781], [-11.970364491313791, 343.33483294293677, 694.11651529420408], [-3.9622118972016147, 346.1573481313996, 695.4057676709923], [1.8838588738401556, 348.69609951855392, 697.57004620744317], [9.2285233032252716, 349.04955202511292, 693.03629295673534], [14.527138543988071, 350.05915586492119, 691.6953389843153], [18.341635294165503, 350.56240199670964, 690.15823117928949]],\
            u6: [[-56.142189904968717, 313.89125344915976, 666.38741665039959], [-54.034652413143405, 315.45820191058522, 668.83430624069911], [-51.359387937977601, 317.42944774881568, 671.89480105082612], [-48.161835722744371, 319.85382742158305, 675.72743340077773], [-43.865989588353969, 322.46720642036809, 679.23027440528244], [-39.044753273511276, 325.65167500049921, 683.80460846176663], [-32.665332129772096, 328.89390998107456, 687.37306259546517], [-28.335317960567938, 331.07105439741821, 689.73500899493843], [-23.67815679952237, 333.12553228721742, 691.5410514311825], [-18.833472521771547, 335.18753288748383, 693.22749851828962], [-10.354108492406603, 338.49766149191657, 695.41487882568049], [-2.5285425121761951, 341.4180630161465, 697.08963808629039], [3.9635753060031829, 343.6104627358344, 697.88987586069834], [10.992549680587841, 344.13315953718228, 694.02265936589993], [17.247670476739316, 344.62997209418273, 690.66217357692005], [20.483464560548988, 345.4434659615722, 690.34691800313533]],\
            u7: [[-55.046628114197212, 309.34841688893925, 668.76713853112312], [-52.805951662530425, 310.84398834933631, 670.93292325600487], [-50.501323852805896, 313.01393585747098, 674.77596714177673], [-46.655054672395494, 315.09053249555382, 677.23892155972749], [-42.975115840872576, 318.03410497219278, 682.04216734192767], [-37.590135753341052, 320.91634541498172, 685.4262328434105], [-31.388183658718482, 324.25372315854707, 689.36938881663605], [-26.866375755753559, 326.32804521885356, 691.32638874680811], [-22.259815513708094, 328.40965071917287, 693.23926816406424], [-17.31215828672245, 330.41644658964515, 694.70830182786369], [-8.8445390086306279, 333.73287166150578, 696.92047958544697], [-0.80234465292571533, 336.53713675356846, 698.13785739735931], [5.0844530839567925, 339.0540540458332, 700.21614646631849], [15.433283491458841, 337.79694598960822, 689.3395039972346], [16.336432516586097, 341.16299903812234, 697.27898109022499], [22.653744129617415, 340.32446347628058, 690.45751898357457]],\
            u8: [[-53.94888745834691, 304.81470717050456, 671.13004596917688], [-52.041642635082333, 306.48903434380856, 673.99982637751214], [-48.862862569000583, 308.19034091790223, 675.99721627389033], [-45.970710784455122, 310.77844852484697, 680.47466023322738], [-41.440962364838477, 313.26643039215764, 683.4836482702201], [-36.465967603800316, 316.36846767806446, 687.73334221104369], [-29.947167343549321, 319.53598025316649, 691.00751623443864], [-25.508493029199805, 321.65487098253169, 693.14004146739342], [-20.740233607709037, 323.64978808968272, 694.7115149871687], [-15.814818414648572, 325.66850811578962, 696.22750969047263], [-7.1772351769541114, 328.89381397106314, 698.08083158764964], [0.42272278828314108, 331.93516599343729, 700.23193158852655], [8.1483548715704011, 333.4662675546943, 698.42777120718563], [16.194545005938295, 333.44362578334278, 692.41284152921389], [19.668663913412487, 335.43135861561757, 694.92406423597265], [24.859103855676491, 335.1969491524876, 690.48183890356779]],\
            u9: [[-52.439355984639874, 298.58445629601403, 674.37439328296693], [-49.897037751275398, 299.91831486796428, 675.90330227631966], [-48.042270784661675, 302.32943684446735, 680.6961663492325], [-43.753919963862025, 304.16902951515061, 682.2257253120373], [-40.088645162117089, 307.12046351083046, 687.05993220525284], [-34.542542421982979, 309.9163246417146, 690.10380906753312], [-28.067282499120857, 313.10717958564788, 693.46991261099959], [-23.467790252081272, 315.13985436620436, 695.26289257953874], [-18.713528378498108, 317.1422756854393, 696.86392002421462], [-13.706652874102931, 319.11732410158237, 698.20792232288386], [-5.0922455878137196, 322.35505479409767, 700.11017709972327], [2.86454263602266, 325.20510688621971, 701.50787838142503], [10.900278378937683, 326.56995906969308, 699.04897616039216], [19.858433450087443, 326.05840464423136, 691.10855614424963], [21.33787896761989, 329.1154999287819, 697.83126131620918], [27.975063423646247, 328.10547764158241, 690.33443106348818]],\
            u10: [[-51.171832747138822, 293.47438101892067, 676.95464577900941], [-49.667759106414955, 295.36485191110188, 680.67566748545119], [-45.548704515173078, 296.56206880459661, 680.6877951854342], [-43.223240798170728, 299.45398301197264, 686.36172417923819], [-38.361591099862331, 301.76402960072039, 688.66994765875961], [-33.063470287571185, 304.69283608687442, 692.23740474528813], [-26.511768895874919, 307.84271006772167, 695.44211248970646], [-21.819566095779376, 309.82568188193, 697.03934669329215], [-17.06104733924251, 311.82582104770165, 698.63138630667936], [-11.939903032425306, 313.73960892494694, 699.73412551929414], [-3.348436721767952, 316.98963848208143, 701.68481705630836], [4.4520615149510183, 319.92347905039935, 703.41250345915785], [14.794917933648502, 320.05146296462243, 696.08242868416812], [19.966431502537979, 321.56996131028473, 696.13698888344095], [25.927915050712457, 322.22419545284538, 693.39647833817867], [30.63301798609233, 322.24997955046024, 689.97897630358318]],\
            u11: [[-50.203927845572956, 289.52146139149482, 678.98520847449004], [-47.63109749015257, 290.83896213873629, 680.44969525834586], [-45.594611374896274, 293.15266283543968, 684.85888398271027], [-41.600070508457506, 295.14976968107339, 687.00878283532131], [-37.304685659768715, 297.76339597930422, 690.51259778204042], [-32.009690923640854, 300.69387838317971, 694.0866551546145], [-25.150347699229055, 303.67882279393706, 696.64181887313759], [-20.586430905459522, 305.73056989688263, 698.50991158865384], [-15.649858579874994, 307.63525293323909, 699.72601522790421], [-10.637645163508477, 309.60743964647838, 701.05874724905766], [-1.909838355513986, 312.78437582935726, 702.7215743082312], [6.2905147653425049, 315.50385057639954, 703.60502132751287], [17.101111195610461, 315.38107483822773, 695.28737692483935], [20.518801754601085, 317.83981356827974, 699.04489666154871], [29.57770014048732, 316.83349559064561, 689.7646145715288], [32.780083160646967, 317.66490143155562, 689.51990192944788]],\
            u12: [[-49.48888429832202, 286.68522784659388, 680.3856343366848], [-47.29802804777502, 288.20750836759009, 682.65660766262113], [-44.519657358003236, 290.12347803126659, 685.49940767767396], [-40.928459451712939, 292.33682068731343, 688.50091051351239], [-36.583408684968006, 294.92382063749369, 691.89986260696992], [-31.032700449272401, 297.71721272053389, 694.93401558968822], [-24.316829542564204, 300.77907393896317, 697.79210165795735], [-19.607677805256142, 302.7529592745787, 699.35355047821645], [-14.746309994430504, 304.69796013175699, 700.72843825567406], [-9.6329957319264352, 306.61594576660974, 701.84770954541614], [-1.0246254006951332, 309.85691292535859, 703.76271053449625], [7.7642947478209567, 312.26085156346051, 703.40347806091813], [18.310712252465304, 312.27970453764868, 695.64361164766729], [21.820754776387503, 314.68893254366384, 699.20614272960972], [31.101830287301961, 313.56350339905509, 689.45676375843107], [34.377056975787809, 314.35585709026861, 689.05825158533651]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 0.5;
    const double v = 0.5;
    //
    const xyz P_ref    (-22.706047383292336, 333.52296737858524, 691.82936585037669);
    const xyz dU_ref   (17.546897305703443, -56.897917238716673, 19.295889729809545);
    const xyz dV_ref   (81.77400940347907, 35.096894390732892, 29.212838153775664);
    const xyz d2U_ref  (0.47248769963618997, 0.2925996490603211, -1.6452620516647585);
    const xyz d2V_ref  (43.216529778428388, -21.764066664486815, -87.653539779464523);
    const xyz d2UV_ref (8.5485138408561028, -4.5829356176438463, -18.049028139532204);

    // Evaluate.
    xyz P, dU, dV, d2U, d2V, d2UV;
    surf->Eval_D2(u, v, P, dU, dV, d2U, d2V, d2UV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2U - d2U_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2V - d2V_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2UV - d2UV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 2-order derivatives
//! out of its parametric domain.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD2OutDomain(const int funcID)
{
  outcome res( DescriptionFn() );

  /* ======================
   *  Prepare input points
   * ====================== */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.51507066945465851, 0.64279998255329296, 0.7479866354308301, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.19874760490017954, 0.36769199242180289, 0.60342534438656004, 1, 1, 1, 1],\
        num_poles_in_U_axis: 7,\
        num_poles_in_V_axis: 7,\
        poles: {\
            u0: [[83.967113457866944, 1389.9202156241026, 331.05829617564888], [87.840101662732181, 1386.5001332781151, 328.48223260556205], [87.601212803300214, 1378.980460273247, 324.86326472920661], [90.357347137565313, 1366.6056710129296, 318.17203841591845], [93.316664399916803, 1350.0404276683739, 309.38552646183825], [94.231562444029066, 1336.7478461707253, 302.67589048039451], [92.070395682684264, 1328.0825249060183, 298.94609345156039]],\
            u1: [[87.72961992030227, 1385.6583638046641, 339.996587770676], [86.074121582961567, 1381.4351192057668, 338.31945691933356], [94.698586131996578, 1375.2030880966586, 333.25930648499593], [88.173646790599079, 1361.4799717696342, 328.07718410611261], [93.311063834292028, 1345.2311563505173, 318.93651280964838], [82.816154968319381, 1330.2809916873623, 314.08211309725897], [87.66790980359788, 1322.6344870311436, 309.21201399314737]],\
            u2: [[88.073744209179651, 1379.6772304066974, 351.91905132432476], [91.286721255866595, 1376.1612635822498, 349.45030566489885], [94.456374471973092, 1369.1367735377937, 345.27710834952273], [93.365926796073239, 1356.2031641646452, 339.21133683256272], [94.491315307464106, 1339.3714930489434, 330.72302196108768], [96.554476577531901, 1326.2457278530787, 323.82667821148971], [92.442069422006341, 1317.2969361269757, 320.41415315556969]],\
            u3: [[91.342099279797026, 1373.1047835416032, 365.38418399048356], [92.057069583677048, 1369.2259136499226, 363.32161459206571], [96.839262400600035, 1362.4356886125001, 358.88621810221838], [98.990280822905319, 1349.9729898935195, 352.29338372454248], [97.409840975609711, 1332.7482239978979, 344.24503693914977], [97.515811181504802, 1319.3381238448235, 337.6669327422789], [98.16173291311209, 1311.0806081342957, 333.48070271474512]],\
            u4: [[93.898698406330794, 1368.8993456298194, 374.05856654750312], [95.706747785264227, 1365.1792750489162, 371.81826233192908], [96.755804640556107, 1357.8467110066842, 367.98987429435948], [102.88108442900014, 1345.9613812815783, 360.75082443843434], [98.589473940105322, 1328.3427444949084, 353.14331439511159], [100.8959159857196, 1315.2523224140771, 346.20741315590095], [100.06034455821795, 1306.7795797378596, 342.26207413228985]],\
            u5: [[95.680178299802051, 1365.7850972621407, 380.46812373633583], [96.845981375710807, 1361.9717230286492, 378.33224886337916], [99.723002616755281, 1354.9047202721549, 374.20663354986425], [104.90837997464688, 1342.8828442883407, 367.12041196634084], [99.992316374247224, 1325.1734887915748, 359.61443809009938], [101.95367679903985, 1312.0329342685486, 352.73464717280723], [101.86614631944096, 1303.6688647795415, 348.66767658187564]],\
            u6: [[96.881429701213023, 1363.5898415460244, 384.97939920790446], [97.98175333291401, 1359.7669546516026, 382.85417130213483], [101.40350099463984, 1352.7790881462165, 378.63998339310274], [101.99606563577518, 1340.0899818488922, 372.30055382772974], [103.95038866349559, 1323.3787358999214, 363.67745408289721], [102.62017642991673, 1309.759991389139, 357.33287336032095], [102.71308394722897, 1301.4221354012407, 353.23656352475399]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 1.1;
    const double v = 1.1;
    //
    const xyz P_ref    (104.53943984031076, 1292.5685875750669, 355.45132840944336);
    const xyz dU_ref   (12.080309354083056, -26.340178053556883, 53.835544419115649);
    const xyz dV_ref   (22.517942991946665, -59.606086811962442, -34.388841735288388);
    const xyz d2U_ref  (-86.780463486775261, -11.254684308398282, 11.424264721055806);
    const xyz d2V_ref  (274.96474650340139, 43.290890528124187, -43.074735047177242);
    const xyz d2UV_ref (190.07621243626522, 27.613712693159414, -30.906419886843764);

    // Evaluate.
    xyz P, dU, dV, d2U, d2V, d2UV;
    surf->Eval_D2(u, v, P, dU, dV, d2U, d2V, d2UV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2U - d2U_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2V - d2V_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2UV - d2UV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}
