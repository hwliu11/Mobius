//-----------------------------------------------------------------------------
// Created on: 15 June 2018
//-----------------------------------------------------------------------------
// Copyright (c) 2013-present, Sergey Slyadnev
// All rights reserved.
//
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are met:
//
//    * Redistributions of source code must retain the above copyright
//      notice, this list of conditions and the following disclaimer.
//    * Redistributions in binary form must reproduce the above copyright
//      notice, this list of conditions and the following disclaimer in the
//      documentation and/or other materials provided with the distribution.
//    * Neither the name of Sergey Slyadnev nor the
//      names of all contributors may be used to endorse or promote products
//      derived from this software without specific prior written permission.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
// ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
// WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
// DISCLAIMED. IN NO EVENT SHALL THE AUTHORS OR CONTRIBUTORS BE LIABLE FOR ANY
// DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
// (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
// LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
// ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
// SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//-----------------------------------------------------------------------------

// Own include
#include <mobius/test_BSplineSurface.h>

// Test includes
#include <mobius/test_CommonFacilities.h>

// Core includes
#include <mobius/core_FileDumper.h>

// Geom includes
#include <mobius/geom_BSplineSurface.h>

#undef FILE_DEBUG
#if defined FILE_DEBUG
  #pragma message("===== warning: FILE_DEBUG is enabled")
#endif

//-----------------------------------------------------------------------------

//! Test scenario 001: evaluate B-surface in its domain.
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalInDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // Control points.
  std::vector< std::vector<xyz> >
    Q = { { xyz(0.0, 0.0, 0.0), xyz(0.0, 1.0, 0.0) },
          { xyz(1.0, 0.0, 0.0), xyz(1.0, 1.0, 0.0) },
          { xyz(2.0, 0.0, 0.0), xyz(2.0, 1.0, 0.0) } };

  // Knot vectors.
  const std::vector<double> U = {0, 0, 0.5, 1, 1};
  const std::vector<double> V = {0, 0, 1, 1};

  // Degrees.
  const int p = 1;
  const int q = 1;

  // Construct B-surface.
  core_Ptr<bsurf> surf = new bsurf(Q, U, V, p, q);

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 0.5;
  const double v   = 0.5;
  //
  const xyz P_ref(1, 0.5, 0);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Test scenario 002: evaluate B-surface out of its domain.
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalOutDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // Control points.
  std::vector< std::vector<xyz> >
    Q = { { xyz(0.0, 0.0, 0.0), xyz(0.0, 1.0, 0.0) },
          { xyz(1.0, 0.0, 0.0), xyz(1.0, 1.0, 0.0) },
          { xyz(2.0, 0.0, 0.0), xyz(2.0, 1.0, 0.0) } };

  // Knot vectors.
  const std::vector<double> U = {0, 0, 0.5, 1, 1};
  const std::vector<double> V = {0, 0, 1, 1};

  // Degrees.
  const int p = 1;
  const int q = 1;

  // Construct B-surface.
  core_Ptr<bsurf> surf = new bsurf(Q, U, V, p, q);

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 1.5;
  const double v   = 1.5;
  //
  const xyz P_ref(3, 1.5, 0);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object.
//!
//! The surface is C0-continuous. It is evaluated in the middle point.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalJSON1(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C0,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 1,\
        V_degree: 1,\
        U_knots: [0, 0, 0.5, 1, 1],\
        V_knots: [0, 0, 0.5, 1, 1],\
        num_poles_in_U_axis: 3,\
        num_poles_in_V_axis: 3,\
        poles: {\
            u0: [[-10, -10, 0], [-10, 0, 0], [-10, 10, 0]],\
            u1: [[0, -10, 0], [0, 0, 10], [0, 10, 0]],\
            u2: [[10, -10, 0], [10, 0, 0], [10, 10, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;
  const double u   = 0.5;
  const double v   = 0.5;
  //
  const xyz P_ref(0, 0, 10);

  // Evaluate.
  xyz P;
  surf->Eval(u, v, P);

  // Check.
  if ( (P - P_ref).Modulus() > eps )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object.
//!
//! The surface has irregular parameterization near the max value of its curvilinear
//! coordinate V = V_max = 5.1866714434994.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalJSON2(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 0.95031615985331297,\
        V_min: 2.7739444971105378,\
        V_max: 5.2866714434994\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.15215133237491321, 0.30430266474982642, 0.45645399712473961, 0.60860532949965274, 0.77946074467648285, 0.95031615985331297, 0.95031615985331297, 0.95031615985331297, 0.95031615985331297],\
        V_knots: [2.7739444971105378, 2.7739444971105378, 2.7739444971105378, 2.7739444971105378, 2.973752686968413, 3.3041696521871251, 3.6345866174058381, 3.9650035826245502, 4.2954205478432623, 4.6258375130619749, 4.9562544782806874, 5.2866714434994, 5.2866714434994, 5.2866714434994, 5.2866714434994],\
        num_poles_in_U_axis: 9,\
        num_poles_in_V_axis: 11,\
        poles: {\
            u0: [[2798.9455164305973, -564.0107501072988, 712.92358035843279], [2866.0958153498605, -566.86516373773884, 711.34840943413406], [3044.2739190469856, -574.94375338520831, 707.12535142508989], [3333.4582744417507, -590.77166362188404, 700.24959668275471], [3665.75713302945, -615.4012941362887, 692.74829403468834], [3998.0229949721997, -648.56699700760407, 686.12506726381753], [4327.4999409546645, -693.43081146947407, 681.52830937981673], [4661.1563125334014, -750.31560089700122, 678.88560100063648], [4960.9120004544548, -855.80928469976186, 686.86268394446665], [5202.6229458470998, -955.68640583188539, 697.50617166126085], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u1: [[2786.8032191605867, -601.09010925355085, 737.9883753135864], [2853.6862794525396, -603.61586285919668, 736.39954051909626], [3031.1574666274264, -610.76173505354575, 732.09513676350753], [3319.028061794223, -624.70616329027621, 724.65478882371872], [3649.9008054113278, -646.38997073254473, 715.68417576931927], [3980.7179363613009, -675.79323128853287, 706.69867073930311], [4309.3170277177051, -716.07548473598888, 698.7806474262444], [4640.6919327410287, -768.13341091857865, 692.03249720688825], [4946.8731591764517, -864.23243353942007, 693.97043948367059], [5178.6558879397608, -960.65911221900387, 701.16669661190952], [5229.8220700325737, -1058.8898967817131, 716.93503449971024]],\
            u2: [[2766.4247543998681, -678.35402023972233, 782.94313479641835], [2832.8601423019977, -680.25817991944859, 781.3189750193975], [3009.1473982313923, -685.6415474059329, 776.84414655063972], [3294.8176626522259, -696.04493646813637, 768.39337717894284], [3623.3108764124177, -712.19483039757267, 756.86139775672586], [3951.7278552909452, -734.45729805037104, 743.77658160836609], [4278.8660407789739, -765.85620379368913, 730.07672949814685], [4606.5177632392015, -808.13530287791457, 716.128098039007], [4923.3883811287624, -885.55311888792244, 707.37267375445549], [5139.302721776191, -972.49694693112633, 707.97292451189492], [5229.8220700325746, -1058.8898967817131, 716.93503449971013]],\
            u3: [[2747.5754465966966, -801.74639499791306, 837.54568985917638], [2813.5997405084795, -802.87355870592353, 835.77311925601578], [2988.8008049665841, -806.04991056540212, 830.82989803882879], [3272.4521423984033, -812.02720047507239, 820.91211099729503], [3598.7941616260487, -821.18862491009565, 806.31547218029459], [3925.1028421397377, -834.1313812710174, 788.60305237665568], [4250.9340789764474, -853.28379131270958, 768.45819007595753], [4575.5202792352102, -880.75855080443625, 746.38567090124025], [4901.9399275821797, -930.71810703772303, 725.39056791537087], [5106.0020356223267, -995.8789437426816, 716.62801515356739], [5229.8220700325737, -1058.8898967817131, 716.93503449971001]],\
            u4: [[2740.4445281314324, -934.41465101791846, 871.60774362345023], [2806.3181426472593, -934.87304933526252, 869.79572560675138], [2981.1227210310235, -936.153968381911, 864.71373114846006], [3264.0367006037541, -938.38746584318721, 854.2579045221712], [3589.64562555168, -941.63883870512734, 838.38796173049457], [3915.3379374428591, -946.41937898357492, 818.58326655697806], [4240.7466357794901, -954.16983632471704, 795.23509233422897], [4564.786565479968, -966.4701744254869, 768.72948485119741], [4894.2701875605471, -989.30103816807582, 740.30903956785914], [5098.4665457017927, -1024.891542423996, 723.72612091198084], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u5: [[2745.2199794700018, -1079.8475752233953, 889.71246336390254], [2811.2078257956427, -1079.7841667307814, 887.86601406621128], [2986.317638729231, -1079.5800579820927, 882.69928518864424], [3269.7981296791322, -1078.892369445131, 872.19041039523245], [3596.1201300409402, -1077.4202026996149, 856.32993176465493], [3922.7238808573397, -1075.215069709604, 836.45662901293292], [4248.6133769267626, -1072.281586679879, 812.6185986497627], [4574.7071344169717, -1068.7065351464989, 784.81047010509008], [4900.6294880342921, -1063.946207398111, 753.14221248495573], [5117.4230174915965, -1060.8929598624311, 729.48318711103423], [5229.8220700325746, -1058.8898967817131, 716.93503449971013]],\
            u6: [[2763.641472566735, -1236.8672900609779, 878.32734964323595], [2830.0471221669159, -1236.5128225990291, 876.74552892021154], [3006.2662815759954, -1235.4600587356158, 872.33440719685848], [3291.807410503935, -1233.0667841399429, 863.59225830802131], [3620.4991822808229, -1228.5536562654361, 850.66845400685361], [3949.7636663509697, -1221.0471988772299, 834.50510116516091], [4277.1685928886536, -1208.609134049341, 814.7504254086482], [4608.2902759889994, -1188.738751843091, 790.69677003169159], [4923.0633696314799, -1156.3096283152222, 762.05145347335235], [5166.7407778915504, -1104.5180234720119, 733.61972813707234], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u7: [[2786.2386397869227, -1347.7882860844377, 852.88494299262015], [2853.152291179128, -1347.4697580816623, 851.5857089173553], [3030.7188246609157, -1346.480076491978, 847.99542478459432], [3318.763090566038, -1344.110613452445, 841.29061329374701], [3650.2866682587924, -1339.1259816890299, 831.94376328058513], [3982.6463439074778, -1329.6505165273279, 820.5178260704746], [4311.8432986449779, -1312.0720624764849, 806.35273964433884], [4648.5616873057506, -1281.3415942363999, 788.03865190698434], [4950.1687797359164, -1230.771068469166, 765.57124495607832], [5222.5199717803953, -1139.2022947231969, 735.12273257278275], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]],\
            u8: [[2799.9999865623431, -1401.9166801004526, 833.9211672781546], [2867.2223681697769, -1401.7258489284618, 832.83717033423216], [3045.60753873161, -1401.0640106744295, 829.86203204549713], [3335.1727105876639, -1399.2245059146978, 824.59098851264946], [3668.410222389793, -1394.6622793516422, 817.66231991812504], [4002.6310411514191, -1384.877086509435, 809.39114981582463], [4332.9098796233584, -1365.33744331056, 798.95536965762994], [4672.9560726785676, -1329.5306692263059, 784.53996145231145], [4966.6172503371636, -1270.390219343657, 766.42653008969262], [5255.8298617696564, -1157.573034130799, 735.51290549326927], [5229.8220700325737, -1058.8898967817131, 716.93503449971013]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test 1.
  {
    const double u = 0.5;
    const double v = 3;
    //
    const xyz P_ref(2966.1562033533373, -975.99025344537256, 868.77888598126765);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 2.
  {
    const double u = 0.5;
    const double v = 5;
    //
    const xyz P_ref(4936.6672840131978, -1017.8903156478241, 740.14824482133531);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 3.
  {
    const double u = 0.95031615985331297; // U_max.
    const double v = 5.2866714434994; // V_max.
    //
    const xyz P_ref(5229.8220700325737, -1058.8898967817131, 716.93503449971013);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  // Test 4.
  {
    const double u = 0.96; // > U_max.
    const double v = 5.29; // > V_max.
    //
    const xyz P_ref(5228.8089992117957, -1055.7995537824584, 716.37072890072977);

    // Evaluate.
    xyz P;
    surf->Eval(u, v, P);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 1-order derivatives.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD1InDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =\
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.14586638621970127, 0.2145640793417587, 0.28307649700999143, 0.34996357207739526, 0.41516162276667518, 0.47821415292419189, 0.54127862619453604, 0.60512428633496806, 0.67470436020123181, 0.74578847214124, 0.81993610554425811, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.14690393242688526, 0.21591144963334422, 0.27704495964889098, 0.3376769446215917, 0.39825108338441551, 0.4583896064467492, 0.52236780332771982, 0.58777285300797455, 0.65458567968353609, 0.7187379588367051, 0.80067148846068914, 1, 1, 1, 1],\
        num_poles_in_U_axis: 15,\
        num_poles_in_V_axis: 15,\
        poles: {\
            u0: [[62.480551458144582, 179.59308573281325, 672.92900658560268], [64.317217499564052, 177.23078342228092, 670.17435680279425], [67.04648849676849, 173.73923792479147, 666.11982934937032], [70.730872244632806, 169.24404869700589, 661.09709386440318], [73.456489438060544, 166.15437307556587, 657.86827443651271], [76.205765087612718, 163.20781001261861, 654.96236681450307], [79.130113652253058, 160.28986095816941, 652.31800724649338], [82.221159974821148, 157.32645186673739, 649.77253449217142], [85.509793040640446, 154.29472882160101, 647.31447126139881], [88.981708802716454, 151.16180402245104, 644.85935709837008], [92.486942182661465, 148.02856022064697, 642.44211276052522], [96.305553390170232, 144.63308281091346, 639.84570037503988], [102.50306901565294, 139.1242458186187, 635.63579611045043], [107.54141936773664, 134.63791838675789, 632.19709406636912], [111.08691458693504, 131.45678236776106, 629.72750266643754]],\
            u1: [[63.696644326691001, 182.59652276387791, 670.8054348291605], [65.528119976522973, 180.2337860721652, 668.04388578237536], [68.283052335246495, 176.74438816071495, 664.02346837713196], [72.041026907032133, 172.25535771082488, 659.09855258686468], [74.859825125180436, 169.17348036102845, 655.99359288638016], [77.696251927222548, 166.23421093284341, 653.20352985850548], [80.700297017942304, 163.32293163933801, 650.66510591446024], [83.84618595210361, 160.36411229763306, 648.19253202492462], [87.18998064223149, 157.3370057002326, 645.80779170265635], [90.681603656665388, 154.20573019081405, 643.37887316166916], [94.203255243239525, 151.07386042020963, 640.98345252241165], [98.023468896131405, 147.67851711829931, 638.38917016767709], [104.23297359763245, 142.17068348556012, 634.19520223446159], [109.26027581522747, 137.68343144105208, 630.74181459392605], [112.80250429085561, 134.50202202998011, 628.26788091540959]],\
            u2: [[65.485528565981184, 187.01935960661012, 667.67551513978037], [67.345642867551575, 184.65901966881233, 664.95203366746273], [70.091478342952385, 181.16886044391333, 660.91952434230313], [74.082958373383505, 176.69937194478132, 656.30499280185086], [77.027082498297645, 173.62798305513724, 653.36662101660545], [80.0007177965295, 170.70019653485369, 650.75894068935929], [83.091407372260079, 167.79616847337175, 648.33568785795444], [86.316396559813185, 164.843968990859, 645.96825700426734], [89.698907457498635, 161.82010253279401, 643.63497972320022], [93.209415055240058, 158.69040746436022, 641.23116328156561], [96.738098886714411, 155.55912621868526, 638.84509016707295], [100.57090828163808, 152.16483704789448, 636.26755054702869], [106.77204925091898, 146.6563034587428, 632.06246522594938], [111.79916110445876, 142.16903548276571, 628.60882454634611], [115.34115417332147, 138.98760637062347, 626.13457795629097]],\
            u3: [[67.904173632790631, 192.86808069567635, 663.61276076657646], [69.798544510667014, 190.5106076729862, 660.93481442564257], [72.708007303179926, 187.03414233341334, 657.11980469284697], [76.97618928969051, 182.58781087751032, 652.87307581344623], [80.073527850790484, 179.52924442458695, 650.13836242707816], [83.177763987639594, 176.61238782076833, 647.70428165315184], [86.350587119790731, 173.71523347403567, 645.39020383821946], [89.637399285491966, 170.76820792450735, 643.1049504154405], [93.034370902796311, 167.74555167656911, 640.79089486750013], [96.565148997649914, 164.61755303552843, 638.41402273404822], [100.10447837781695, 161.48716271030335, 636.04210008380801], [103.93221075393043, 158.09244864644114, 633.45781189914794], [110.13246072472874, 152.58384049008757, 629.25154222933509], [115.14109605956334, 148.0950262238411, 625.77334186520818], [118.67834409327438, 144.91320000216729, 623.29278799572637]],\
            u4: [[69.691275710741337, 197.09210513567584, 660.7365357308696], [71.620662330082695, 194.73756256223291, 658.10513363223674], [74.692223654473025, 191.2746631647417, 654.50559137290247], [79.149415899825087, 186.8441498793961, 650.51010204797387], [82.342262303134021, 183.79357642826443, 647.90234128244629], [85.521780025763817, 180.88302010132483, 645.56832762756119], [88.739623550655367, 177.98963348791679, 643.31409261420004], [92.044143458921511, 175.04408989018214, 641.05237698973724], [95.458001893980182, 172.02284689126594, 638.7607680359431], [98.994619915828665, 168.89533699068667, 636.39165855339115], [102.53068879969564, 165.76467379621755, 634.01540192867355], [106.36400439303873, 162.3704269889094, 631.43853516662955], [112.54689858661972, 156.86036633656173, 627.20919554408954], [117.56899425799146, 152.37267855889891, 623.74888716622957], [121.09471256788834, 149.18988742061794, 621.25300755362457]],\
            u5: [[71.506127463688586, 201.25187894769059, 657.98300470566437], [73.518446409089023, 198.90427693761367, 655.46183937819308], [76.758191585647779, 195.45545275950354, 652.08585342922242], [81.35511482445699, 191.03663348854801, 648.27609980329203], [84.631120864347935, 187.99301962428189, 645.77887795862682], [87.861359260024869, 185.08670808417025, 643.51228413258116], [91.103226729212182, 182.1953320222037, 641.2899826507537], [94.428519203883667, 179.25152686978026, 639.05587870388672], [97.846172713164378, 176.23060147865738, 636.76931430567424], [101.38743541488202, 173.10348028892918, 634.40637870653359], [104.92595349624649, 169.97302206652731, 632.03337764736875], [108.74989485388342, 166.57799073429521, 629.44405029817494], [114.9474219302368, 161.06915470031663, 625.23416125451377], [119.93498376408989, 156.57857680370105, 621.72794919922592], [123.45887471163971, 153.39563273441172, 619.22964058776802]],\
            u6: [[73.346923162589064, 205.30707998653847, 655.40154519609678], [75.456474961894429, 202.96761534358737, 653.00962543997696], [78.838951494464737, 199.5307362786547, 649.82336338490734], [83.562144311634881, 195.12248444323782, 646.18145203804102], [86.901557671947401, 192.08417710474072, 643.76851359170337], [90.161895231630353, 189.18038454805762, 641.5419287080324], [93.42023820513684, 186.29038731250438, 639.3415270870421], [96.752066891229603, 183.34712917222586, 637.11611131855841], [100.17929397465781, 180.32700498855979, 634.84227247566002], [103.71983523845637, 177.19982342206529, 632.47837791406562], [107.25544315198827, 174.06912164922761, 630.10150855021664], [111.08070622383289, 170.67420093057103, 627.51393807332613], [117.2451944287812, 165.16259989057758, 623.26013251749907], [122.26189054537653, 160.67446022697598, 619.79264684807185], [125.77145365260883, 157.49031706816061, 617.27529313165667]],\
            u7: [[75.236428625634133, 209.29174980044704, 652.98099687099989], [77.439675725012478, 206.96012646857685, 650.71362043644854], [80.951054221658183, 203.53403514217834, 647.69869972667902], [85.768919629533656, 199.13370640678937, 644.18263075289599], [89.156623019963561, 196.09944043587299, 641.83388123326836], [92.42700306747318, 193.19648832978922, 639.62064520263323], [95.701706828122454, 190.30786032002877, 637.44199095608565], [99.041993003974056, 187.36530998268231, 635.22781720151204], [102.46383513512129, 184.34473513515212, 632.94682047723643], [106.00800715079268, 181.21785742439957, 630.58775204777032], [109.53843065715368, 178.08672177121372, 628.20399137465711], [113.35634222319324, 174.69118580884825, 625.60664899938206], [119.54055940478547, 169.18123587667992, 621.37906794233083], [124.51323334809739, 164.68941202022322, 617.85306634223662], [128.02259008433253, 161.50525159032574, 615.33543830971632]],\
            u8: [[77.190399348404284, 213.25588919114713, 650.67955440601543], [79.482004991560927, 210.93166053999005, 648.52962747557524], [83.103052053817663, 207.51474731898335, 645.66048235350672], [87.9939969943553, 203.12053457178916, 642.24155344682924], [91.405585938410681, 200.0882675704708, 639.92455350464706], [94.693264905049787, 197.18676320195911, 637.73431184882384], [97.973239114537023, 194.29857627332888, 635.56266328136462], [101.31628347252509, 191.35625676681565, 633.35215580636452], [104.74547804048053, 188.3362972409096, 631.08093221799857], [108.27858617173061, 185.20849359940627, 628.70715725667674], [111.81553212297091, 182.07790380625045, 626.33206646294218], [115.62401630227028, 178.68157887077714, 623.72219285016206], [121.79166458432206, 173.1702422959975, 619.47258778783146], [126.76843636814165, 168.67876138568815, 615.9520331916699], [130.27041202403959, 165.49398323700439, 613.4245939491833]],\
            u9: [[79.287141939825659, 217.36335002519314, 648.39855880499692], [81.665264209750646, 215.04636190567075, 646.36363303320979], [85.37537445834765, 211.63690233654651, 643.61287405268354], [90.318066870426193, 207.24702030841445, 640.26272983406966], [93.747725111685483, 204.21626551720959, 637.96974828224916], [97.043566753161116, 201.31544427872234, 635.79035676123726], [100.33076777325391, 198.42786215812475, 633.62831434260897], [103.67468630290277, 195.48561581058433, 631.41896884950245], [107.09523005640196, 192.46493230250212, 629.1362462727584], [110.63687961188853, 189.33784348836434, 626.77382489421393], [114.15237199266522, 186.20545825702058, 624.37021720664598], [117.97182879496231, 182.81005161467633, 621.77492881759883], [124.12211323889406, 177.29726186928789, 617.50224308769214], [129.09103100474908, 172.80512366028739, 613.97124863505462], [132.58067246793897, 169.61931326941152, 611.42741431909621]],\
            u10: [[81.54457332594302, 221.64517702306975, 646.12374406552522], [83.993045158655562, 219.33407642197889, 644.18232958207113], [87.785844227572582, 215.9315370373528, 641.54148369570476], [92.748315309012511, 211.54331027580324, 638.21763002930129], [96.194788267656165, 208.51396269957797, 635.94699923309713], [99.500452053151818, 205.61396347123068, 633.78066367583426], [102.78329028743745, 202.72601623135088, 631.61282207800048], [106.12892004882914, 199.78391309590802, 629.40575121857501], [109.55046507558056, 196.76331338386476, 627.12435957194634], [113.07640959151435, 193.63491022311035, 624.7410624633535], [116.60717977088476, 190.50380358280881, 622.3577626010607], [120.40881254780352, 187.10690525702313, 619.73878184620082], [126.54862887701739, 181.59323944054162, 615.45218150396465], [131.51028869718917, 177.10049381783037, 611.91153951657998], [134.9903273935401, 173.91387977637694, 609.3549408412847]],\
            u11: [[83.98121356904376, 226.14837070780354, 643.82114500094656], [86.50643085191642, 223.84369289364264, 641.98174346019755], [90.328552940761114, 220.44360753735032, 639.37987483627137], [95.321490819616514, 216.05793052627843, 636.09651878441991], [98.774795127007025, 213.02915466208759, 633.83496847424829], [102.07872360880604, 210.1290102070738, 631.66632628595835], [105.36998814281783, 207.2417681598491, 629.5096852430687], [108.70487887504655, 204.29876628062377, 627.2883396616312], [112.12905987993805, 201.27838717222428, 625.01045185642113], [115.6547483182657, 198.14996258046796, 622.62681435982961], [119.17151050257338, 195.01768361832296, 620.22489454293702], [122.96406794818193, 191.62002578276545, 617.59385051590846], [129.10223135078868, 186.10622163371377, 613.30505304137262], [134.03578682652181, 181.61112397298822, 609.72705370090887], [137.51250071496216, 178.42423168008526, 607.16603556571965]],\
            u12: [[87.757093160722803, 232.97493490908371, 640.44850892783495], [90.344583276407505, 230.67546867601158, 638.69188278175409], [94.215483708371977, 227.27946555396139, 636.15485216857053], [99.227139514904621, 222.89535503655216, 632.89637669113415], [102.68937196211233, 219.86732636375308, 630.64669400065623], [105.99903694466801, 216.96766199351313, 628.48567698521776], [109.28026656252911, 214.0795801293587, 626.31569715384978], [112.62142132457781, 211.13710248354164, 624.10267795676066], [116.02120488128818, 208.11468156535403, 621.79236014458456], [119.54932799722351, 204.98646073050392, 619.41195891316102], [123.04833441542566, 201.85269579750076, 616.98643746325035], [126.84999031857963, 198.45579940713722, 614.36748744865395], [132.931993392565, 192.93729522930326, 610.00403955023103], [137.88349112575921, 188.44369914680175, 606.44988973411398], [141.32655440641395, 185.25399065198113, 603.84414194372323]],\
            u13: [[90.785755383573161, 238.31619883682606, 637.91649309178729], [93.394896703119173, 236.01854458177831, 636.18864654129675], [97.279317054757087, 232.62367293479653, 633.66958711452469], [102.29912678166019, 228.24024481475391, 630.42195013513322], [105.75878834228514, 225.21200098579047, 628.16885012538739], [109.05986583107955, 222.31161793265005, 625.99641828981976], [112.34017984447405, 219.42345944203311, 623.82522140251319], [115.65918196811879, 216.47912785339341, 621.58275608415602], [119.08498868279067, 213.45888479980289, 619.3070292336123], [122.58164101733202, 210.32803019157663, 616.88479585432344], [126.09401031345001, 207.19538359089591, 614.47703684500675], [129.84515274908676, 203.79425975462937, 611.79094242696704], [135.96928530728385, 198.2792813714826, 607.48349462562157], [140.83451066196145, 193.77846519835819, 603.81466831482805], [144.29761270438041, 190.59043373711879, 601.23555680126515]],\
            u14: [[92.94233193702668, 242.10042723092349, 636.13811021161246], [95.561920411489851, 239.80364729285392, 634.42415041289416], [99.453566608437569, 236.40938037311847, 631.9146958518445], [104.47245803928998, 232.02587540135636, 628.66583823875953], [107.92913964626121, 228.99738218161608, 626.40877716238526], [111.2310379114887, 226.09706781883031, 624.23743633376694], [114.50420999309833, 223.20831162364524, 622.05674612175403], [117.83244229617613, 220.26475250393668, 619.82654990552226], [121.23231276266567, 217.24233885918386, 617.51634761709533], [124.738447303109, 214.11227781185249, 615.10671834300638], [128.2262618779759, 210.97757623928342, 612.66632027343087], [131.99137335650968, 207.57762146497259, 609.99879403330874], [138.07148814740987, 202.05895925770594, 605.63283615789226], [142.95882995175077, 197.55999399878513, 601.99340786493224], [146.39227476974759, 194.36948053981192, 599.37487485172937]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 0.5;
    const double v = 0.5;
    //
    const xyz P_ref  (102.01056087867869, 186.81000791347395, 633.12859242907416);
    const xyz dU_ref (35.950281444623457, 63.027026776358525, -29.57316833575419);
    const xyz dV_ref (54.198526472252823, -47.810554718737549, -36.061975169786187);

    // Evaluate.
    xyz P, dU, dV;
    surf->Eval_D1(u, v, P, dU, dV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 1-order derivatives
//! out of its parametric domain.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD1OutDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 1,\
        U_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\
        V_knots: [0, 0, 1, 1],\
        num_poles_in_U_axis: 6,\
        num_poles_in_V_axis: 2,\
        poles: {\
            u0: [[241.87747035573125, 62.485923112593042, 0], [307.49011857707512, 49.837701768719491, 0]],\
            u1: [[245.29391602546553, 57.035146252318057, 0], [306.57174310419981, 45.021517271473421, 0]],\
            u2: [[250.62433050286035, 49.413132207145885, 25], [303.8174241480333, 37.906450425886014, 0]],\
            u3: [[260.43129359394032, 37.406082628166004, -22], [295.65540308364263, 29.098297811030434, -30]],\
            u4: [[266.65853554251112, 30.811365428505532, 0], [288.81855843279288, 26.561552469297354, 0]],\
            u5: [[271.12648221343875, 26.517543665952715, 0], [284.16996047430831, 25.727029831960614, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 1.1; // Out of range
    const double v = 1.1; // Out of range
    //
    const xyz P_ref  (281.32712540796518, 25.457981859438284, -4.6248038997486107);
    const xyz dU_ref (-41.09642504354224, -0.19347502194278832, -99.247529960069542);
    const xyz dV_ref (6.1947345560560407, 1.9242835963289397, -1.0971603699159702);

    // Evaluate.
    xyz P, dU, dV;
    surf->Eval_D1(u, v, P, dU, dV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 2-order derivatives.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD2InDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C3,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 4,\
        V_degree: 6,\
        U_knots: [0, 0, 0, 0, 0, 0.206392961480693, 0.29068747464739936, 0.37478665622968027, 0.45843065841149361, 0.54193027126411775, 0.62497941754339359, 0.70808932166508454, 0.79129395135668346, 1, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0, 0, 0, 0.23031026431400881, 0.28839397730608679, 0.34529326822772871, 0.4015964749653777, 0.45824315522017756, 0.51626394341957227, 0.57449586388738816, 0.63468555729632492, 0.69890042086688409, 1, 1, 1, 1, 1, 1, 1],\
        num_poles_in_U_axis: 13,\
        num_poles_in_V_axis: 16,\
        poles: {\
            u0: [[-62.662010160417445, 341.19642674033247, 651.90482970001995], [-60.619909862716064, 342.7984566736049, 654.48988105505339], [-57.972793198183631, 344.7847928078055, 657.6098061516218], [-54.85481118739164, 347.25183078712519, 661.61044020172631], [-50.923047771204111, 350.06039782539074, 665.88199251071092], [-46.221511821011021, 353.30903885406519, 670.70905766059082], [-40.467358585829551, 356.88648561789097, 675.59768022197704], [-36.436622214762295, 359.22407556970171, 678.59151112216443], [-32.139815495048666, 361.47174273601479, 681.15839311167827], [-27.584109030277109, 363.68866695650968, 683.45497767710401], [-19.575968659728812, 367.25142282810384, 686.63728286106971], [-11.940946043520681, 370.27397637382984, 688.71434860478519], [-5.4984238567094268, 372.4929647602533, 689.61930083164998], [-1.1999135395521472, 374.4794880482051, 691.51708905278338], [4.5010472266249408, 375.27339081138632, 689.32663704524282], [8.020645266084566, 375.93473481025666, 688.41216789152509]],\
            u1: [[-61.979433202339052, 338.36816854761429, 653.38499257149795], [-60.049754822021136, 340.03046888798178, 656.20740756515863], [-57.132437561037229, 341.87194803766431, 658.75684073073637], [-54.366359859424705, 344.52764510115679, 663.50047302551673], [-50.052739638607683, 347.13149525141665, 666.96578645601596], [-45.609113816222873, 350.51840423318669, 672.33739387848902], [-39.640026884696567, 353.98062309766919, 676.77221307642742], [-35.650914601471285, 356.34052809959059, 679.85392759553656], [-31.272708367120941, 358.54455624959638, 682.24894554440505], [-26.725685959830827, 360.76613607188227, 684.56386531999215], [-18.634969360601794, 364.28462208012303, 687.57182199111151], [-10.944300966335209, 367.27734342075058, 689.53139921781963], [-4.6392579111010415, 369.57003561351979, 690.72661999430215], [-0.024366724136580992, 371.38694425455145, 691.95641289746538], [5.388431655135375, 372.33533348064827, 690.37437670652469], [9.2769028893552523, 372.79892122222333, 688.6810818065195]],\
            u2: [[-61.030726468158271, 334.39469129525219, 655.49269036215549], [-58.64777829368925, 335.8139895978004, 657.35808763069315], [-56.819885265903856, 338.2395189359998, 662.20769238239575], [-52.75058942396371, 340.19654896293878, 664.19975623801542], [-49.552861761955278, 343.39863921058912, 670.02112553615791], [-44.28183602327632, 346.34197161089082, 673.64579019760197], [-38.698800805986359, 350.0111562923916, 678.8957052570405], [-34.426128768664462, 352.21904234446851, 681.37872179468673], [-30.163130365550547, 354.48483445521583, 684.01698546165835], [-25.441598691844987, 356.61285828079895, 685.96345257765245], [-17.370715553845901, 360.14197718706441, 689.01328491356662], [-9.5802111411851971, 363.08117553489484, 690.76207192112327], [-3.2199131064089945, 365.34424503320855, 691.84062929877507], [1.3523788361292581, 367.18399151457595, 693.16036473163558], [7.5258601090621591, 367.72457175870483, 689.97224972898857], [11.048489289026833, 368.38429073571587, 689.05138073294518]],\
            u3: [[-59.806396315495228, 329.2726015860934, 658.20586610313785], [-58.105963474727737, 331.0578025344409, 661.51230197709674], [-54.728704463754553, 332.65270275037466, 663.09063048714597], [-52.281933638640801, 335.47958311946246, 668.50843596651964], [-47.700045405072807, 337.93961236078729, 671.40733785442762], [-43.243876043447735, 341.31979663766748, 676.75246129421885], [-37.133503545376847, 344.70627103156733, 680.88897517103908], [-33.013550503769324, 346.99603111906259, 683.69443716558283], [-28.514742157548458, 349.1354033856756, 685.83482010404066], [-23.841935186762804, 351.28954896536646, 687.88416282514447], [-15.594458987342914, 354.72399473356836, 690.5611428507741], [-7.8815482077915382, 357.70479173020101, 692.47375829611087], [-1.255275575859454, 359.82526984038111, 692.99074636727016], [2.5830802612180292, 362.05848610865883, 695.86008839463682], [11.25730639153206, 361.25839440775138, 687.39198962612522], [13.360713972859077, 362.67897092504722, 689.46761464619362]],\
            u4: [[-58.319791766562254, 323.01953045612368, 661.5402773564175], [-56.055103771017784, 324.50222911060132, 663.65536496140828], [-53.877213219636545, 326.74012160963616, 667.7659973876772], [-50.171889404746565, 328.89228033348741, 670.52653883839673], [-46.453051481414327, 331.81499865502059, 675.24765446139827], [-41.414949072188421, 334.88320335973992, 679.36410515792613], [-35.393417392457863, 338.31730612017873, 683.68819437943705], [-31.084836949925105, 340.50594135132309, 686.09539518722522], [-26.606359422487724, 342.65621315384612, 688.27870389350119], [-21.815157619668618, 344.74688619283273, 690.07807197635191], [-13.531809676431322, 348.16210079461274, 692.67931367768915], [-5.531642535941371, 350.98889705701026, 693.9854262573142], [0.25944681718789347, 353.55712447979693, 696.26579060437052], [6.831844205658764, 354.3245963344944, 693.36257452222094], [12.643833145578848, 355.05897588916969, 690.93770157679774], [16.223770657051535, 355.68797135112385, 689.89583380752856]],\
            u5: [[-57.227891477090594, 318.44398987148202, 663.96885936864226], [-55.298920421522332, 320.10666941505838, 666.79276778265864], [-52.388434830419605, 321.95181108475498, 669.35662509302108], [-49.25346178328963, 324.40974001574551, 673.32138487321004], [-45.187992308743873, 327.14662602635303, 677.31063496513434], [-40.178224157805445, 330.230020983293, 681.48690960706278], [-34.079904194086467, 333.62295684990795, 685.64887077633216], [-29.707864795264573, 335.77757116040232, 687.92208660040387], [-25.167297286383548, 337.89455596207785, 689.97430072777559], [-20.310395416851442, 339.95000660084168, 691.63495202604781], [-11.970364491313791, 343.33483294293677, 694.11651529420408], [-3.9622118972016147, 346.1573481313996, 695.4057676709923], [1.8838588738401556, 348.69609951855392, 697.57004620744317], [9.2285233032252716, 349.04955202511292, 693.03629295673534], [14.527138543988071, 350.05915586492119, 691.6953389843153], [18.341635294165503, 350.56240199670964, 690.15823117928949]],\
            u6: [[-56.142189904968717, 313.89125344915976, 666.38741665039959], [-54.034652413143405, 315.45820191058522, 668.83430624069911], [-51.359387937977601, 317.42944774881568, 671.89480105082612], [-48.161835722744371, 319.85382742158305, 675.72743340077773], [-43.865989588353969, 322.46720642036809, 679.23027440528244], [-39.044753273511276, 325.65167500049921, 683.80460846176663], [-32.665332129772096, 328.89390998107456, 687.37306259546517], [-28.335317960567938, 331.07105439741821, 689.73500899493843], [-23.67815679952237, 333.12553228721742, 691.5410514311825], [-18.833472521771547, 335.18753288748383, 693.22749851828962], [-10.354108492406603, 338.49766149191657, 695.41487882568049], [-2.5285425121761951, 341.4180630161465, 697.08963808629039], [3.9635753060031829, 343.6104627358344, 697.88987586069834], [10.992549680587841, 344.13315953718228, 694.02265936589993], [17.247670476739316, 344.62997209418273, 690.66217357692005], [20.483464560548988, 345.4434659615722, 690.34691800313533]],\
            u7: [[-55.046628114197212, 309.34841688893925, 668.76713853112312], [-52.805951662530425, 310.84398834933631, 670.93292325600487], [-50.501323852805896, 313.01393585747098, 674.77596714177673], [-46.655054672395494, 315.09053249555382, 677.23892155972749], [-42.975115840872576, 318.03410497219278, 682.04216734192767], [-37.590135753341052, 320.91634541498172, 685.4262328434105], [-31.388183658718482, 324.25372315854707, 689.36938881663605], [-26.866375755753559, 326.32804521885356, 691.32638874680811], [-22.259815513708094, 328.40965071917287, 693.23926816406424], [-17.31215828672245, 330.41644658964515, 694.70830182786369], [-8.8445390086306279, 333.73287166150578, 696.92047958544697], [-0.80234465292571533, 336.53713675356846, 698.13785739735931], [5.0844530839567925, 339.0540540458332, 700.21614646631849], [15.433283491458841, 337.79694598960822, 689.3395039972346], [16.336432516586097, 341.16299903812234, 697.27898109022499], [22.653744129617415, 340.32446347628058, 690.45751898357457]],\
            u8: [[-53.94888745834691, 304.81470717050456, 671.13004596917688], [-52.041642635082333, 306.48903434380856, 673.99982637751214], [-48.862862569000583, 308.19034091790223, 675.99721627389033], [-45.970710784455122, 310.77844852484697, 680.47466023322738], [-41.440962364838477, 313.26643039215764, 683.4836482702201], [-36.465967603800316, 316.36846767806446, 687.73334221104369], [-29.947167343549321, 319.53598025316649, 691.00751623443864], [-25.508493029199805, 321.65487098253169, 693.14004146739342], [-20.740233607709037, 323.64978808968272, 694.7115149871687], [-15.814818414648572, 325.66850811578962, 696.22750969047263], [-7.1772351769541114, 328.89381397106314, 698.08083158764964], [0.42272278828314108, 331.93516599343729, 700.23193158852655], [8.1483548715704011, 333.4662675546943, 698.42777120718563], [16.194545005938295, 333.44362578334278, 692.41284152921389], [19.668663913412487, 335.43135861561757, 694.92406423597265], [24.859103855676491, 335.1969491524876, 690.48183890356779]],\
            u9: [[-52.439355984639874, 298.58445629601403, 674.37439328296693], [-49.897037751275398, 299.91831486796428, 675.90330227631966], [-48.042270784661675, 302.32943684446735, 680.6961663492325], [-43.753919963862025, 304.16902951515061, 682.2257253120373], [-40.088645162117089, 307.12046351083046, 687.05993220525284], [-34.542542421982979, 309.9163246417146, 690.10380906753312], [-28.067282499120857, 313.10717958564788, 693.46991261099959], [-23.467790252081272, 315.13985436620436, 695.26289257953874], [-18.713528378498108, 317.1422756854393, 696.86392002421462], [-13.706652874102931, 319.11732410158237, 698.20792232288386], [-5.0922455878137196, 322.35505479409767, 700.11017709972327], [2.86454263602266, 325.20510688621971, 701.50787838142503], [10.900278378937683, 326.56995906969308, 699.04897616039216], [19.858433450087443, 326.05840464423136, 691.10855614424963], [21.33787896761989, 329.1154999287819, 697.83126131620918], [27.975063423646247, 328.10547764158241, 690.33443106348818]],\
            u10: [[-51.171832747138822, 293.47438101892067, 676.95464577900941], [-49.667759106414955, 295.36485191110188, 680.67566748545119], [-45.548704515173078, 296.56206880459661, 680.6877951854342], [-43.223240798170728, 299.45398301197264, 686.36172417923819], [-38.361591099862331, 301.76402960072039, 688.66994765875961], [-33.063470287571185, 304.69283608687442, 692.23740474528813], [-26.511768895874919, 307.84271006772167, 695.44211248970646], [-21.819566095779376, 309.82568188193, 697.03934669329215], [-17.06104733924251, 311.82582104770165, 698.63138630667936], [-11.939903032425306, 313.73960892494694, 699.73412551929414], [-3.348436721767952, 316.98963848208143, 701.68481705630836], [4.4520615149510183, 319.92347905039935, 703.41250345915785], [14.794917933648502, 320.05146296462243, 696.08242868416812], [19.966431502537979, 321.56996131028473, 696.13698888344095], [25.927915050712457, 322.22419545284538, 693.39647833817867], [30.63301798609233, 322.24997955046024, 689.97897630358318]],\
            u11: [[-50.203927845572956, 289.52146139149482, 678.98520847449004], [-47.63109749015257, 290.83896213873629, 680.44969525834586], [-45.594611374896274, 293.15266283543968, 684.85888398271027], [-41.600070508457506, 295.14976968107339, 687.00878283532131], [-37.304685659768715, 297.76339597930422, 690.51259778204042], [-32.009690923640854, 300.69387838317971, 694.0866551546145], [-25.150347699229055, 303.67882279393706, 696.64181887313759], [-20.586430905459522, 305.73056989688263, 698.50991158865384], [-15.649858579874994, 307.63525293323909, 699.72601522790421], [-10.637645163508477, 309.60743964647838, 701.05874724905766], [-1.909838355513986, 312.78437582935726, 702.7215743082312], [6.2905147653425049, 315.50385057639954, 703.60502132751287], [17.101111195610461, 315.38107483822773, 695.28737692483935], [20.518801754601085, 317.83981356827974, 699.04489666154871], [29.57770014048732, 316.83349559064561, 689.7646145715288], [32.780083160646967, 317.66490143155562, 689.51990192944788]],\
            u12: [[-49.48888429832202, 286.68522784659388, 680.3856343366848], [-47.29802804777502, 288.20750836759009, 682.65660766262113], [-44.519657358003236, 290.12347803126659, 685.49940767767396], [-40.928459451712939, 292.33682068731343, 688.50091051351239], [-36.583408684968006, 294.92382063749369, 691.89986260696992], [-31.032700449272401, 297.71721272053389, 694.93401558968822], [-24.316829542564204, 300.77907393896317, 697.79210165795735], [-19.607677805256142, 302.7529592745787, 699.35355047821645], [-14.746309994430504, 304.69796013175699, 700.72843825567406], [-9.6329957319264352, 306.61594576660974, 701.84770954541614], [-1.0246254006951332, 309.85691292535859, 703.76271053449625], [7.7642947478209567, 312.26085156346051, 703.40347806091813], [18.310712252465304, 312.27970453764868, 695.64361164766729], [21.820754776387503, 314.68893254366384, 699.20614272960972], [31.101830287301961, 313.56350339905509, 689.45676375843107], [34.377056975787809, 314.35585709026861, 689.05825158533651]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 0.5;
    const double v = 0.5;
    //
    const xyz P_ref    (-22.706047383292336, 333.52296737858524, 691.82936585037669);
    const xyz dU_ref   (17.546897305703443, -56.897917238716673, 19.295889729809545);
    const xyz dV_ref   (81.77400940347907, 35.096894390732892, 29.212838153775664);
    const xyz d2U_ref  (0.47248769963618997, 0.2925996490603211, -1.6452620516647585);
    const xyz d2V_ref  (43.216529778428388, -21.764066664486815, -87.653539779464523);
    const xyz d2UV_ref (8.5485138408561028, -4.5829356176438463, -18.049028139532204);

    // Evaluate.
    xyz P, dU, dV, d2U, d2V, d2UV;
    surf->Eval_D2(u, v, P, dU, dV, d2U, d2V, d2UV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2U - d2U_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2V - d2V_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2UV - d2UV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Evaluates B-surface specified as JSON object with its 2-order derivatives
//! out of its parametric domain.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::evalD2OutDomain(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.51507066945465851, 0.64279998255329296, 0.7479866354308301, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.19874760490017954, 0.36769199242180289, 0.60342534438656004, 1, 1, 1, 1],\
        num_poles_in_U_axis: 7,\
        num_poles_in_V_axis: 7,\
        poles: {\
            u0: [[83.967113457866944, 1389.9202156241026, 331.05829617564888], [87.840101662732181, 1386.5001332781151, 328.48223260556205], [87.601212803300214, 1378.980460273247, 324.86326472920661], [90.357347137565313, 1366.6056710129296, 318.17203841591845], [93.316664399916803, 1350.0404276683739, 309.38552646183825], [94.231562444029066, 1336.7478461707253, 302.67589048039451], [92.070395682684264, 1328.0825249060183, 298.94609345156039]],\
            u1: [[87.72961992030227, 1385.6583638046641, 339.996587770676], [86.074121582961567, 1381.4351192057668, 338.31945691933356], [94.698586131996578, 1375.2030880966586, 333.25930648499593], [88.173646790599079, 1361.4799717696342, 328.07718410611261], [93.311063834292028, 1345.2311563505173, 318.93651280964838], [82.816154968319381, 1330.2809916873623, 314.08211309725897], [87.66790980359788, 1322.6344870311436, 309.21201399314737]],\
            u2: [[88.073744209179651, 1379.6772304066974, 351.91905132432476], [91.286721255866595, 1376.1612635822498, 349.45030566489885], [94.456374471973092, 1369.1367735377937, 345.27710834952273], [93.365926796073239, 1356.2031641646452, 339.21133683256272], [94.491315307464106, 1339.3714930489434, 330.72302196108768], [96.554476577531901, 1326.2457278530787, 323.82667821148971], [92.442069422006341, 1317.2969361269757, 320.41415315556969]],\
            u3: [[91.342099279797026, 1373.1047835416032, 365.38418399048356], [92.057069583677048, 1369.2259136499226, 363.32161459206571], [96.839262400600035, 1362.4356886125001, 358.88621810221838], [98.990280822905319, 1349.9729898935195, 352.29338372454248], [97.409840975609711, 1332.7482239978979, 344.24503693914977], [97.515811181504802, 1319.3381238448235, 337.6669327422789], [98.16173291311209, 1311.0806081342957, 333.48070271474512]],\
            u4: [[93.898698406330794, 1368.8993456298194, 374.05856654750312], [95.706747785264227, 1365.1792750489162, 371.81826233192908], [96.755804640556107, 1357.8467110066842, 367.98987429435948], [102.88108442900014, 1345.9613812815783, 360.75082443843434], [98.589473940105322, 1328.3427444949084, 353.14331439511159], [100.8959159857196, 1315.2523224140771, 346.20741315590095], [100.06034455821795, 1306.7795797378596, 342.26207413228985]],\
            u5: [[95.680178299802051, 1365.7850972621407, 380.46812373633583], [96.845981375710807, 1361.9717230286492, 378.33224886337916], [99.723002616755281, 1354.9047202721549, 374.20663354986425], [104.90837997464688, 1342.8828442883407, 367.12041196634084], [99.992316374247224, 1325.1734887915748, 359.61443809009938], [101.95367679903985, 1312.0329342685486, 352.73464717280723], [101.86614631944096, 1303.6688647795415, 348.66767658187564]],\
            u6: [[96.881429701213023, 1363.5898415460244, 384.97939920790446], [97.98175333291401, 1359.7669546516026, 382.85417130213483], [101.40350099463984, 1352.7790881462165, 378.63998339310274], [101.99606563577518, 1340.0899818488922, 372.30055382772974], [103.95038866349559, 1323.3787358999214, 363.67745408289721], [102.62017642991673, 1309.759991389139, 357.33287336032095], [102.71308394722897, 1301.4221354012407, 353.23656352475399]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-7;

  // Test.
  {
    const double u = 1.1;
    const double v = 1.1;
    //
    const xyz P_ref    (104.53943984031076, 1292.5685875750669, 355.45132840944336);
    const xyz dU_ref   (12.080309354083056, -26.340178053556883, 53.835544419115649);
    const xyz dV_ref   (22.517942991946665, -59.606086811962442, -34.388841735288388);
    const xyz d2U_ref  (-86.780463486775261, -11.254684308398282, 11.424264721055806);
    const xyz d2V_ref  (274.96474650340139, 43.290890528124187, -43.074735047177242);
    const xyz d2UV_ref (190.07621243626522, 27.613712693159414, -30.906419886843764);

    // Evaluate.
    xyz P, dU, dV, d2U, d2V, d2UV;
    surf->Eval_D2(u, v, P, dU, dV, d2U, d2V, d2UV);

    // Check.
    if ( (P - P_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dU - dU_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (dV - dV_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2U - d2U_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2V - d2V_ref).Modulus() > eps )
      return res.failure();

    // Check.
    if ( (d2UV - d2UV_ref).Modulus() > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy01(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C3,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 4,\
        V_degree: 6,\
        U_knots: [0, 0, 0, 0, 0, 0.206392961480693, 0.29068747464739936, 0.37478665622968027, 0.45843065841149361, 0.54193027126411775, 0.62497941754339359, 0.70808932166508454, 0.79129395135668346, 1, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0, 0, 0, 0.23031026431400881, 0.28839397730608679, 0.34529326822772871, 0.4015964749653777, 0.45824315522017756, 0.51626394341957227, 0.57449586388738816, 0.63468555729632492, 0.69890042086688409, 1, 1, 1, 1, 1, 1, 1],\
        num_poles_in_U_axis: 13,\
        num_poles_in_V_axis: 16,\
        poles: {\
            u0: [[-62.662010160417445, 341.19642674033247, 651.90482970001995], [-60.619909862716064, 342.7984566736049, 654.48988105505339], [-57.972793198183631, 344.7847928078055, 657.6098061516218], [-54.85481118739164, 347.25183078712519, 661.61044020172631], [-50.923047771204111, 350.06039782539074, 665.88199251071092], [-46.221511821011021, 353.30903885406519, 670.70905766059082], [-40.467358585829551, 356.88648561789097, 675.59768022197704], [-36.436622214762295, 359.22407556970171, 678.59151112216443], [-32.139815495048666, 361.47174273601479, 681.15839311167827], [-27.584109030277109, 363.68866695650968, 683.45497767710401], [-19.575968659728812, 367.25142282810384, 686.63728286106971], [-11.940946043520681, 370.27397637382984, 688.71434860478519], [-5.4984238567094268, 372.4929647602533, 689.61930083164998], [-1.1999135395521472, 374.4794880482051, 691.51708905278338], [4.5010472266249408, 375.27339081138632, 689.32663704524282], [8.020645266084566, 375.93473481025666, 688.41216789152509]],\
            u1: [[-61.979433202339052, 338.36816854761429, 653.38499257149795], [-60.049754822021136, 340.03046888798178, 656.20740756515863], [-57.132437561037229, 341.87194803766431, 658.75684073073637], [-54.366359859424705, 344.52764510115679, 663.50047302551673], [-50.052739638607683, 347.13149525141665, 666.96578645601596], [-45.609113816222873, 350.51840423318669, 672.33739387848902], [-39.640026884696567, 353.98062309766919, 676.77221307642742], [-35.650914601471285, 356.34052809959059, 679.85392759553656], [-31.272708367120941, 358.54455624959638, 682.24894554440505], [-26.725685959830827, 360.76613607188227, 684.56386531999215], [-18.634969360601794, 364.28462208012303, 687.57182199111151], [-10.944300966335209, 367.27734342075058, 689.53139921781963], [-4.6392579111010415, 369.57003561351979, 690.72661999430215], [-0.024366724136580992, 371.38694425455145, 691.95641289746538], [5.388431655135375, 372.33533348064827, 690.37437670652469], [9.2769028893552523, 372.79892122222333, 688.6810818065195]],\
            u2: [[-61.030726468158271, 334.39469129525219, 655.49269036215549], [-58.64777829368925, 335.8139895978004, 657.35808763069315], [-56.819885265903856, 338.2395189359998, 662.20769238239575], [-52.75058942396371, 340.19654896293878, 664.19975623801542], [-49.552861761955278, 343.39863921058912, 670.02112553615791], [-44.28183602327632, 346.34197161089082, 673.64579019760197], [-38.698800805986359, 350.0111562923916, 678.8957052570405], [-34.426128768664462, 352.21904234446851, 681.37872179468673], [-30.163130365550547, 354.48483445521583, 684.01698546165835], [-25.441598691844987, 356.61285828079895, 685.96345257765245], [-17.370715553845901, 360.14197718706441, 689.01328491356662], [-9.5802111411851971, 363.08117553489484, 690.76207192112327], [-3.2199131064089945, 365.34424503320855, 691.84062929877507], [1.3523788361292581, 367.18399151457595, 693.16036473163558], [7.5258601090621591, 367.72457175870483, 689.97224972898857], [11.048489289026833, 368.38429073571587, 689.05138073294518]],\
            u3: [[-59.806396315495228, 329.2726015860934, 658.20586610313785], [-58.105963474727737, 331.0578025344409, 661.51230197709674], [-54.728704463754553, 332.65270275037466, 663.09063048714597], [-52.281933638640801, 335.47958311946246, 668.50843596651964], [-47.700045405072807, 337.93961236078729, 671.40733785442762], [-43.243876043447735, 341.31979663766748, 676.75246129421885], [-37.133503545376847, 344.70627103156733, 680.88897517103908], [-33.013550503769324, 346.99603111906259, 683.69443716558283], [-28.514742157548458, 349.1354033856756, 685.83482010404066], [-23.841935186762804, 351.28954896536646, 687.88416282514447], [-15.594458987342914, 354.72399473356836, 690.5611428507741], [-7.8815482077915382, 357.70479173020101, 692.47375829611087], [-1.255275575859454, 359.82526984038111, 692.99074636727016], [2.5830802612180292, 362.05848610865883, 695.86008839463682], [11.25730639153206, 361.25839440775138, 687.39198962612522], [13.360713972859077, 362.67897092504722, 689.46761464619362]],\
            u4: [[-58.319791766562254, 323.01953045612368, 661.5402773564175], [-56.055103771017784, 324.50222911060132, 663.65536496140828], [-53.877213219636545, 326.74012160963616, 667.7659973876772], [-50.171889404746565, 328.89228033348741, 670.52653883839673], [-46.453051481414327, 331.81499865502059, 675.24765446139827], [-41.414949072188421, 334.88320335973992, 679.36410515792613], [-35.393417392457863, 338.31730612017873, 683.68819437943705], [-31.084836949925105, 340.50594135132309, 686.09539518722522], [-26.606359422487724, 342.65621315384612, 688.27870389350119], [-21.815157619668618, 344.74688619283273, 690.07807197635191], [-13.531809676431322, 348.16210079461274, 692.67931367768915], [-5.531642535941371, 350.98889705701026, 693.9854262573142], [0.25944681718789347, 353.55712447979693, 696.26579060437052], [6.831844205658764, 354.3245963344944, 693.36257452222094], [12.643833145578848, 355.05897588916969, 690.93770157679774], [16.223770657051535, 355.68797135112385, 689.89583380752856]],\
            u5: [[-57.227891477090594, 318.44398987148202, 663.96885936864226], [-55.298920421522332, 320.10666941505838, 666.79276778265864], [-52.388434830419605, 321.95181108475498, 669.35662509302108], [-49.25346178328963, 324.40974001574551, 673.32138487321004], [-45.187992308743873, 327.14662602635303, 677.31063496513434], [-40.178224157805445, 330.230020983293, 681.48690960706278], [-34.079904194086467, 333.62295684990795, 685.64887077633216], [-29.707864795264573, 335.77757116040232, 687.92208660040387], [-25.167297286383548, 337.89455596207785, 689.97430072777559], [-20.310395416851442, 339.95000660084168, 691.63495202604781], [-11.970364491313791, 343.33483294293677, 694.11651529420408], [-3.9622118972016147, 346.1573481313996, 695.4057676709923], [1.8838588738401556, 348.69609951855392, 697.57004620744317], [9.2285233032252716, 349.04955202511292, 693.03629295673534], [14.527138543988071, 350.05915586492119, 691.6953389843153], [18.341635294165503, 350.56240199670964, 690.15823117928949]],\
            u6: [[-56.142189904968717, 313.89125344915976, 666.38741665039959], [-54.034652413143405, 315.45820191058522, 668.83430624069911], [-51.359387937977601, 317.42944774881568, 671.89480105082612], [-48.161835722744371, 319.85382742158305, 675.72743340077773], [-43.865989588353969, 322.46720642036809, 679.23027440528244], [-39.044753273511276, 325.65167500049921, 683.80460846176663], [-32.665332129772096, 328.89390998107456, 687.37306259546517], [-28.335317960567938, 331.07105439741821, 689.73500899493843], [-23.67815679952237, 333.12553228721742, 691.5410514311825], [-18.833472521771547, 335.18753288748383, 693.22749851828962], [-10.354108492406603, 338.49766149191657, 695.41487882568049], [-2.5285425121761951, 341.4180630161465, 697.08963808629039], [3.9635753060031829, 343.6104627358344, 697.88987586069834], [10.992549680587841, 344.13315953718228, 694.02265936589993], [17.247670476739316, 344.62997209418273, 690.66217357692005], [20.483464560548988, 345.4434659615722, 690.34691800313533]],\
            u7: [[-55.046628114197212, 309.34841688893925, 668.76713853112312], [-52.805951662530425, 310.84398834933631, 670.93292325600487], [-50.501323852805896, 313.01393585747098, 674.77596714177673], [-46.655054672395494, 315.09053249555382, 677.23892155972749], [-42.975115840872576, 318.03410497219278, 682.04216734192767], [-37.590135753341052, 320.91634541498172, 685.4262328434105], [-31.388183658718482, 324.25372315854707, 689.36938881663605], [-26.866375755753559, 326.32804521885356, 691.32638874680811], [-22.259815513708094, 328.40965071917287, 693.23926816406424], [-17.31215828672245, 330.41644658964515, 694.70830182786369], [-8.8445390086306279, 333.73287166150578, 696.92047958544697], [-0.80234465292571533, 336.53713675356846, 698.13785739735931], [5.0844530839567925, 339.0540540458332, 700.21614646631849], [15.433283491458841, 337.79694598960822, 689.3395039972346], [16.336432516586097, 341.16299903812234, 697.27898109022499], [22.653744129617415, 340.32446347628058, 690.45751898357457]],\
            u8: [[-53.94888745834691, 304.81470717050456, 671.13004596917688], [-52.041642635082333, 306.48903434380856, 673.99982637751214], [-48.862862569000583, 308.19034091790223, 675.99721627389033], [-45.970710784455122, 310.77844852484697, 680.47466023322738], [-41.440962364838477, 313.26643039215764, 683.4836482702201], [-36.465967603800316, 316.36846767806446, 687.73334221104369], [-29.947167343549321, 319.53598025316649, 691.00751623443864], [-25.508493029199805, 321.65487098253169, 693.14004146739342], [-20.740233607709037, 323.64978808968272, 694.7115149871687], [-15.814818414648572, 325.66850811578962, 696.22750969047263], [-7.1772351769541114, 328.89381397106314, 698.08083158764964], [0.42272278828314108, 331.93516599343729, 700.23193158852655], [8.1483548715704011, 333.4662675546943, 698.42777120718563], [16.194545005938295, 333.44362578334278, 692.41284152921389], [19.668663913412487, 335.43135861561757, 694.92406423597265], [24.859103855676491, 335.1969491524876, 690.48183890356779]],\
            u9: [[-52.439355984639874, 298.58445629601403, 674.37439328296693], [-49.897037751275398, 299.91831486796428, 675.90330227631966], [-48.042270784661675, 302.32943684446735, 680.6961663492325], [-43.753919963862025, 304.16902951515061, 682.2257253120373], [-40.088645162117089, 307.12046351083046, 687.05993220525284], [-34.542542421982979, 309.9163246417146, 690.10380906753312], [-28.067282499120857, 313.10717958564788, 693.46991261099959], [-23.467790252081272, 315.13985436620436, 695.26289257953874], [-18.713528378498108, 317.1422756854393, 696.86392002421462], [-13.706652874102931, 319.11732410158237, 698.20792232288386], [-5.0922455878137196, 322.35505479409767, 700.11017709972327], [2.86454263602266, 325.20510688621971, 701.50787838142503], [10.900278378937683, 326.56995906969308, 699.04897616039216], [19.858433450087443, 326.05840464423136, 691.10855614424963], [21.33787896761989, 329.1154999287819, 697.83126131620918], [27.975063423646247, 328.10547764158241, 690.33443106348818]],\
            u10: [[-51.171832747138822, 293.47438101892067, 676.95464577900941], [-49.667759106414955, 295.36485191110188, 680.67566748545119], [-45.548704515173078, 296.56206880459661, 680.6877951854342], [-43.223240798170728, 299.45398301197264, 686.36172417923819], [-38.361591099862331, 301.76402960072039, 688.66994765875961], [-33.063470287571185, 304.69283608687442, 692.23740474528813], [-26.511768895874919, 307.84271006772167, 695.44211248970646], [-21.819566095779376, 309.82568188193, 697.03934669329215], [-17.06104733924251, 311.82582104770165, 698.63138630667936], [-11.939903032425306, 313.73960892494694, 699.73412551929414], [-3.348436721767952, 316.98963848208143, 701.68481705630836], [4.4520615149510183, 319.92347905039935, 703.41250345915785], [14.794917933648502, 320.05146296462243, 696.08242868416812], [19.966431502537979, 321.56996131028473, 696.13698888344095], [25.927915050712457, 322.22419545284538, 693.39647833817867], [30.63301798609233, 322.24997955046024, 689.97897630358318]],\
            u11: [[-50.203927845572956, 289.52146139149482, 678.98520847449004], [-47.63109749015257, 290.83896213873629, 680.44969525834586], [-45.594611374896274, 293.15266283543968, 684.85888398271027], [-41.600070508457506, 295.14976968107339, 687.00878283532131], [-37.304685659768715, 297.76339597930422, 690.51259778204042], [-32.009690923640854, 300.69387838317971, 694.0866551546145], [-25.150347699229055, 303.67882279393706, 696.64181887313759], [-20.586430905459522, 305.73056989688263, 698.50991158865384], [-15.649858579874994, 307.63525293323909, 699.72601522790421], [-10.637645163508477, 309.60743964647838, 701.05874724905766], [-1.909838355513986, 312.78437582935726, 702.7215743082312], [6.2905147653425049, 315.50385057639954, 703.60502132751287], [17.101111195610461, 315.38107483822773, 695.28737692483935], [20.518801754601085, 317.83981356827974, 699.04489666154871], [29.57770014048732, 316.83349559064561, 689.7646145715288], [32.780083160646967, 317.66490143155562, 689.51990192944788]],\
            u12: [[-49.48888429832202, 286.68522784659388, 680.3856343366848], [-47.29802804777502, 288.20750836759009, 682.65660766262113], [-44.519657358003236, 290.12347803126659, 685.49940767767396], [-40.928459451712939, 292.33682068731343, 688.50091051351239], [-36.583408684968006, 294.92382063749369, 691.89986260696992], [-31.032700449272401, 297.71721272053389, 694.93401558968822], [-24.316829542564204, 300.77907393896317, 697.79210165795735], [-19.607677805256142, 302.7529592745787, 699.35355047821645], [-14.746309994430504, 304.69796013175699, 700.72843825567406], [-9.6329957319264352, 306.61594576660974, 701.84770954541614], [-1.0246254006951332, 309.85691292535859, 703.76271053449625], [7.7642947478209567, 312.26085156346051, 703.40347806091813], [18.310712252465304, 312.27970453764868, 695.64361164766729], [21.820754776387503, 314.68893254366384, 699.20614272960972], [31.101830287301961, 313.56350339905509, 689.45676375843107], [34.377056975787809, 314.35585709026861, 689.05825158533651]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 104333.863;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy02(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.25, 0.5, 0.75, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.16666666999999999, 0.33333332999999998, 0.5, 0.66666667000000002, 0.83333332999999998, 1, 1, 1, 1],\
        num_poles_in_U_axis: 7,\
        num_poles_in_V_axis: 9,\
        poles: {\
            u0: [[64.92469054, -93.493416809999999, -5.3733773500000002], [64.786041190000006, -83.278844520000007, -3.2544836199999998], [64.548435350000005, -62.72740546, 0.55294007000000001], [64.336892820000003, -31.60954795, 4.8878456200000002], [64.267770130000002, -0.29125588000000002, 7.7884035100000002], [64.336451969999999, 31.127946810000001, 9.2315123499999991], [64.547504849999996, 62.546301249999999, 9.2262663800000002], [64.784764929999994, 83.426353259999999, 8.2872174399999992], [64.923261870000005, 93.835463050000001, 7.5960983400000002]],\
            u1: [[54.109947200000001, -93.352760380000007, -5.0116032099999996], [54.21298822, -83.60657827, -2.3875475399999999], [54.387385729999998, -63.571094809999998, 2.31207297], [54.551368320000002, -32.354174710000002, 7.5201276699999999], [54.607418359999997, -0.47472962000000002, 10.75342459], [54.55078589, 31.54640225, 11.944334980000001], [54.386187649999997, 63.184021340000001, 11.087982330000001], [54.211374220000003, 83.676880569999994, 9.1942012399999999], [54.108148049999997, 93.692205740000006, 7.9382215]],\
            u2: [[32.472053969999997, -93.12899161, -4.4398912099999999], [32.727891370000002, -84.084117599999999, -1.07480635], [33.184975049999998, -64.878108170000004, 5.0109652799999997], [33.631080259999997, -33.545410109999999, 11.674273660000001], [33.785686599999998, -0.76684949999999996, 15.47856964], [33.630535700000003, 32.22343454, 16.22773793], [33.18387826, 64.176026840000006, 13.945916240000001], [32.726417290000001, 84.038049939999993, 10.564933890000001], [32.470389140000002, 93.460686999999993, 8.4783883600000003]],\
            u3: [[0, -93.017970829999996, -4.1411824099999999], [0, -84.31624506, -0.42348392000000001], [0, -65.539813730000006, 6.3570412000000003], [0, -34.165027729999998, 13.798153709999999], [0, -0.91725920000000005, 17.916390740000001], [0, 32.580774329999997, 18.419169199999999], [0, 64.681525570000005, 15.372676390000001], [0, 84.213092470000007, 11.244360329999999], [0, 93.344056899999998, 8.7612962200000002]],\
            u4: [[-32.472053969999997, -93.12899161, -4.4398912099999999], [-32.727891370000002, -84.084117599999999, -1.07480635], [-33.184975049999998, -64.878108170000004, 5.0109652799999997], [-33.631080259999997, -33.545410109999999, 11.674273660000001], [-33.785686599999998, -0.76684949999999996, 15.47856964], [-33.630535700000003, 32.22343454, 16.22773793], [-33.18387826, 64.176026840000006, 13.945916240000001], [-32.726417290000001, 84.038049939999993, 10.564933890000001], [-32.470389140000002, 93.460686999999993, 8.4783883600000003]],\
            u5: [[-54.109947200000001, -93.352760380000007, -5.0116032099999996], [-54.21298822, -83.60657827, -2.3875475399999999], [-54.387385729999998, -63.571094809999998, 2.31207297], [-54.551368320000002, -32.354174710000002, 7.5201276699999999], [-54.607418359999997, -0.47472962000000002, 10.75342459], [-54.55078589, 31.54640225, 11.944334980000001], [-54.386187649999997, 63.184021340000001, 11.087982330000001], [-54.211374220000003, 83.676880569999994, 9.1942012399999999], [-54.108148049999997, 93.692205740000006, 7.9382215]],\
            u6: [[-64.92469054, -93.493416809999999, -5.3733773500000002], [-64.786041190000006, -83.278844520000007, -3.2544836199999998], [-64.548435350000005, -62.72740546, 0.55294007000000001], [-64.336892820000003, -31.60954795, 4.8878456200000002], [-64.267770130000002, -0.29125588000000002, 7.7884035100000002], [-64.336451969999999, 31.127946810000001, 9.2315123499999991], [-64.547504849999996, 62.546301249999999, 9.2262663800000002], [-64.784764929999994, 83.426353259999999, 8.2872174399999992], [-64.923261870000005, 93.835463050000001, 7.5960983400000002]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 20747.437;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy03(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: CN,\
    domain: {\
        U_min: 0,\
        U_max: 10,\
        V_min: 0,\
        V_max: 10\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 1,\
        V_degree: 1,\
        U_knots: [0, 0, 10, 10],\
        V_knots: [0, 0, 10, 10],\
        num_poles_in_U_axis: 2,\
        num_poles_in_V_axis: 2,\
        poles: {\
            u0: [[0, 10, 0], [10, 10, 0]],\
            u1: [[0, 10, 10], [10, 10, 10]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 0.0;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy04(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C3,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 5,\
        V_degree: 5,\
        U_knots: [0, 0, 0, 0, 0, 0, 0.28453473790794015, 0.36489408059560774, 0.44551317931028844, 0.52750818109623265, 0.61195218585475486, 0.69976618238612087, 1, 1, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0, 0, 0.22996980069030787, 0.30679450649039691, 0.38305850280759318, 0.46004142452011798, 0.53955189188304309, 0.63271230305568293, 1, 1, 1, 1, 1, 1],\
        num_poles_in_U_axis: 12,\
        num_poles_in_V_axis: 12,\
        poles: {\
            u0: [[17.363661374333933, 1439.9437756670407, 123.86809157124502], [12.480051924608006, 1442.78205517691, 126.74541026701304], [10.812768150371827, 1439.3306346949132, 131.39046295716685], [0.79763719102999397, 1446.5383492490894, 136.14184754846323], [-3.1657224399410731, 1443.5931999801044, 142.82591680049666], [-10.28097369681937, 1443.6583187366973, 150.39057048239212], [-15.026922745490252, 1442.9007514594455, 156.09997970579792], [-23.458924676760553, 1442.1170591744494, 165.77785385242069], [-30.236056458321151, 1440.2808450847504, 174.55589723528536], [-37.968903667351022, 1441.8709590905482, 181.51823918316487], [-36.497757538684127, 1431.3391629810087, 188.66957970722015], [-42.987875125772071, 1434.12561940103, 193.30999708514406]],\
            u1: [[15.223591576843909, 1436.1439713657396, 120.98532315402589], [11.44288248863052, 1437.4842906089884, 123.92291597040006], [-15.013310341070499, 1467.7011887833764, 127.21324093877668], [16.646875374452708, 1418.3054506089516, 134.24220485746292], [-18.773047903406454, 1458.0846344813772, 139.2071553411437], [-13.118742554850735, 1440.8061299292328, 147.46967242192608], [-14.145638623883563, 1434.997341537829, 153.38232996735223], [-40.0525035813193, 1457.9480239897064, 162.10519309180083], [-15.125622338149695, 1413.0513907902769, 172.61587848967224], [-67.957240060813817, 1475.8946956188283, 177.11354744629338], [-15.626524132323494, 1396.2853858956878, 187.04439185935755], [-44.435546467354882, 1429.385398891875, 190.46506863017055]],\
            u2: [[1.1985613318734372, 1446.6418025190383, 116.69233140612333], [-7.436346333675683, 1454.5750986519902, 119.36463955970568], [16.258666919443748, 1416.6765834525856, 125.39575594447574], [-28.503382175770287, 1471.0775935853496, 128.24820205729191], [-1.6789286459647792, 1426.3164086888862, 136.61484249018713], [-21.188564869626546, 1443.2155922959262, 143.50213611274106], [-28.373231077852161, 1445.7702928662209, 149.07826808162037], [-28.428627843117432, 1433.6094878831216, 159.21392837798095], [-43.560979958007785, 1443.1213415924592, 167.53535430416102], [-31.633960886991897, 1418.0094074696074, 175.57211892211029], [-58.851610023572206, 1446.4427589869024, 181.15560076539234], [-51.947933794264301, 1431.0377525548338, 186.52799645433606]],\
            u3: [[-2.6910447660637016, 1440.4818824194031, 111.76063280175549], [0.96993339254036748, 1431.7148953263297, 115.10491798153666], [-26.320544167720179, 1463.064919774894, 118.34964882353248], [1.9774159184716511, 1418.2357594853149, 125.19486523413821], [-29.067483608172729, 1452.0727821494904, 130.39891320879693], [-26.506877917666223, 1438.9961432656089, 138.49235787577246], [-31.575056729180023, 1438.6762287431548, 144.18415706271009], [-36.181011886293255, 1432.6959962756644, 154.07112680196977], [-47.420742189373705, 1436.9208875263521, 162.60528668375537], [-45.854016081075805, 1425.8803126576911, 170.07585550623378], [-52.737568818758241, 1426.6958760903542, 176.77060707204095], [-56.380720518012488, 1425.6155808715075, 181.56661272546293]],\
            u4: [[-12.444318189376364, 1440.3606430251132, 105.71444314264664], [-19.094495519571574, 1445.5982766249358, 108.49521791731185], [-8.6494096927621342, 1425.6958248168339, 113.80221836959701], [-32.940761491952081, 1452.293515402991, 117.77339952028781], [-25.228527147349613, 1433.4905638566856, 125.09554650262777], [-34.885740181412103, 1437.0081773937159, 132.52128055399379], [-36.746282958489182, 1432.3316487136894, 138.38837884132479], [-47.544449726075051, 1434.7616836453483, 147.93694075840074], [-43.606582277324122, 1418.3723479284827, 157.30056483235361], [-61.456422111308548, 1433.7033704502358, 163.71000748405203], [-57.596506805442935, 1419.9271458878209, 170.99189557749852], [-60.060043204536527, 1417.2446961034868, 175.85236786575612]],\
            u5: [[-20.934916003548224, 1436.1766669384554, 98.769013757265512], [-22.473323388058073, 1434.4714899835858, 101.8291496138262], [-31.841914274478103, 1441.4799917734467, 106.05332156996282], [-28.691238787966643, 1430.8058961278964, 111.52422483518728], [-37.670293786769264, 1434.6730688352634, 117.93418353465236], [-40.92911966250594, 1429.5003871579295, 125.70959301701825], [-46.56821769003421, 1429.9558956300298, 131.37019115000413], [-48.488301457772479, 1420.3277102169334, 141.4039452604581], [-64.163086463107504, 1430.5762967677767, 149.69572692627543], [-54.801413626840151, 1408.9486182166481, 157.59229394005487], [-63.455846489052867, 1412.169392632976, 164.19026591822461], [-64.669635341901426, 1407.7895346031617, 169.11903760773004]],\
            u6: [[-27.98072062417414, 1435.2622650246394, 94.060232858629206], [-30.95131475854981, 1435.5022854062984, 97.042098909590891], [-30.711055137737418, 1429.4600377631837, 101.79139991143845], [-38.827879205755231, 1434.0894701839482, 106.64652803434244], [-39.98440429283751, 1427.3320757036786, 113.48399236151003], [-47.90205519962975, 1428.4870143891289, 121.00479445448501], [-47.750161803144969, 1421.0771930815251, 126.98187350242772], [-64.53275366334455, 1431.6352795761723, 136.20338324654446], [-47.79983369631875, 1397.8676919787636, 146.26626408525971], [-74.573852292100653, 1425.3195421507091, 152.18799538444759], [-56.114261848920606, 1391.7140256375581, 160.2677638764701], [-66.775291392561073, 1400.1654184420884, 164.68023858697509]],\
            u7: [[-34.668918694278211, 1428.1565694203878, 87.017947196318019], [-36.10672418441122, 1426.3147548817717, 90.083581002583017], [-44.008216325437608, 1431.3306418312563, 94.387930724365944], [-41.695260782543194, 1421.7943381693522, 99.813052126901312], [-52.317843905560494, 1427.893752258663, 106.13319109664363], [-50.918900140163878, 1416.3948836501133, 114.16315029075449], [-66.790095520191201, 1430.7476359830175, 119.26455858991753], [-43.137273024140029, 1386.3863061974714, 130.69588630736084], [-88.688122190639106, 1437.2125900615049, 137.35492438425413], [-36.223794217336355, 1357.0428463939318, 147.60707556939303], [-92.53707366575658, 1424.9939092659151, 151.60046496937332], [-73.22687500181658, 1392.7383528635196, 157.65088403707264]],\
            u8: [[-42.401902019893335, 1425.9270360074302, 81.344323004423117], [-43.12977327613028, 1423.1209881514581, 84.448755112989318], [-47.753617437235597, 1423.6851706558361, 88.932230127088232], [-51.633777076390281, 1422.560361624837, 94.018894326739613], [-51.920416258738996, 1414.6214873234883, 100.90389840433946], [-67.987122293984399, 1426.8444800406658, 107.97935008418747], [-45.387729456708342, 1388.9464447289452, 115.18319751104386], [-88.495463885445602, 1435.2593636242234, 122.96602351407596], [-29.350093749716223, 1343.8871479214206, 135.34676843722721], [-113.89211801894002, 1449.7995555469759, 138.1114459692476], [-41.700893219619267, 1343.2156847470167, 149.12767828207245], [-66.875189693707327, 1371.3790097978413, 152.74699485075826]],\
            u9: [[-46.314012982528233, 1420.1267456613286, 76.547103909379246], [-57.492018810428803, 1431.5140800140546, 79.080430328348783], [-40.139523926913043, 1402.2299789897791, 84.764924542613045], [-65.537980370345153, 1430.331340103058, 88.675601806301984], [-63.388466073999432, 1419.0836799479146, 95.693743031832938], [-48.624391259702094, 1389.4322782838658, 104.4541141007299], [-78.510349991746054, 1422.819894852785, 108.78960775699285], [-38.655793698065395, 1356.4533555977764, 121.10636927337278], [-107.64016125617135, 1439.1070652950459, 126.48475248510796], [-32.900159872373273, 1328.6824818927525, 137.95428166065466], [-84.679828209251639, 1390.475990060595, 142.1954354394145], [-73.72726640461299, 1369.5717835849907, 147.78910498592245]],\
            u10: [[-51.452458956461065, 1418.955550457202, 72.905038655634741], [-40.176664280705786, 1399.8461126965515, 76.665477810119313], [-77.827384261324411, 1445.2674277527212, 79.344015618782123], [-46.417741571066735, 1396.2119773414227, 86.359287221232861], [-56.916962832686799, 1402.1438412391431, 92.686167985589762], [-71.037907029086355, 1411.7240984703437, 99.86795663642603], [-53.19028405709232, 1380.2799212791269, 106.81211718680073], [-85.605429290554468, 1412.0701558770618, 115.17929915999633], [-50.443391804494347, 1353.2721242290663, 126.24934156177589], [-73.338201534469377, 1375.455229417757, 132.38307379159207], [-79.032647910946054, 1374.6557475170823, 139.14281068403096], [-68.29319488151792, 1354.0409855724586, 144.72483371698505]],\
            u11: [[-54.066864569912191, 1416.1498329682902, 70.140626770972915], [-56.311191023528288, 1415.4034359303287, 73.162183756228885], [-57.388987104166858, 1411.1513727307622, 77.839452278002739], [-59.337803100310239, 1407.4034110203529, 83.031665486192566], [-61.292249965625139, 1401.7297546195925, 89.825522942627771], [-63.736048842920738, 1395.4501025372617, 97.645474105562514], [-65.679450584464149, 1390.886112977578, 103.50804410421907], [-68.26406492309124, 1382.1604935857533, 113.5054812479072], [-66.980155283183194, 1369.3757657606122, 122.72406504566366], [-70.705145419167337, 1365.5224046718815, 129.90543862053875], [-68.241981270287454, 1353.6432487917555, 137.11099348332749], [-70.24913023851947, 1350.3409331868334, 141.99640759952209]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 953253.754;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy05(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 3,\
        U_knots: [0, 0, 0, 0, 0.20493723581786072, 0.28446252149831619, 0.36412484098602999, 0.44499684416163826, 0.52638188722588219, 0.60989297446501489, 0.69622603026356122, 0.78787984611241735, 1, 1, 1, 1],\
        V_knots: [0, 0, 0, 0, 0.15545179180452687, 0.23272530828999019, 0.30431781121397633, 0.38126652738519234, 0.45927657795347754, 0.53890449818754371, 0.62065428394440036, 0.72040747829412588, 1, 1, 1, 1],\
        num_poles_in_U_axis: 12,\
        num_poles_in_V_axis: 12,\
        poles: {\
            u0: [[17.363661374333926, 1439.9437756670407, 123.86809157124509], [13.059414742126739, 1441.3846775428613, 127.28291696681399], [7.3129201011153144, 1442.2969473705523, 132.68004058715866], [-1.0472216067868669, 1444.7860127539666, 139.5691903427103], [-5.3333574637799002, 1443.8702970431257, 144.917297993284], [-10.044543739626755, 1443.5312746096613, 150.24268232708246], [-14.7898305169093, 1443.0018012734452, 155.76238563461558], [-19.570105723177743, 1442.4288433550114, 161.35558355532865], [-24.662663925514604, 1441.6298324502227, 167.4704622054808], [-33.982416287852125, 1440.8707520900282, 178.0784963040814], [-37.911583077429, 1435.2240049909897, 186.96447587666088], [-42.987875125772106, 1434.1256194010316, 193.30999708514409]],\
            u1: [[11.42428853174699, 1440.097855276488, 120.28018432720651], [3.5933031014100107, 1446.3287769715603, 123.50227147815907], [0.089665747240140731, 1444.1947960076029, 129.02196850162133], [-5.5542211759390385, 1442.9946416904154, 136.0595630978884], [-11.123412334787684, 1443.8215728487762, 141.33755105977013], [-14.726227060406593, 1441.9771591752649, 146.72350851769278], [-18.603793320699427, 1440.2691470495645, 152.29063323600644], [-26.657004613984789, 1444.1414938790363, 157.70496337198722], [-29.423937197616421, 1440.1838161595524, 163.94693876080871], [-37.2634273096971, 1437.4142422748068, 174.63587001795133], [-42.546015701823741, 1433.6057136181089, 183.44788434421289], [-46.146856665618792, 1430.5033690332043, 189.87403977834492]],\
            u2: [[0.24143582551130668, 1443.6417324011229, 114.86664124805269], [-1.9847861100880961, 1442.2602592581513, 118.39503185364089], [-6.9897659246290589, 1442.165402979158, 123.83267967330686], [-13.587968236097067, 1442.2614006838128, 130.81812040072438], [-17.259548065799951, 1440.5109944219435, 136.19981388135159], [-22.840934318582669, 1441.3538783826916, 141.47764130049907], [-28.380983411924579, 1441.9038519415858, 146.95391040367167], [-30.982151221191387, 1438.3712283894422, 152.66619776042432], [-35.600595046322844, 1436.9282749095382, 158.80698702603163], [-42.344112463662889, 1432.6701499214603, 169.55581380292207], [-48.258371977300108, 1429.7195575521976, 178.33330694967401], [-53.595180867082803, 1428.9750061714572, 184.66459076730234]],\
            u3: [[-8.6536824911182002, 1440.2666032180623, 108.00609501752928], [-11.935766269323793, 1440.3192025828616, 111.47678218383524], [-16.816526148053882, 1440.0556306749122, 116.92121869235726], [-22.476192369215088, 1438.8769078144833, 123.95795094117935], [-27.925642745790139, 1439.5412069342779, 129.24248280367431], [-31.46603052997289, 1437.6120049325425, 134.63185192880476], [-34.954484797250501, 1435.375500546678, 140.22024183481346], [-38.958750477209932, 1433.7485657891016, 145.85584910945576], [-42.927693420590607, 1431.4234596252973, 152.03213396092605], [-50.04095513675739, 1427.6675216776457, 162.76075400542365], [-55.968642527210768, 1424.7351670628079, 171.53751331121009], [-58.64561309129563, 1420.3780208670353, 178.01415877856672]],\
            u4: [[-15.05049469572667, 1438.7458216289092, 103.44622888986862], [-18.053039027825122, 1438.4187502656616, 106.93219304299635], [-22.523524252601717, 1437.5979429523509, 112.39905129045086], [-29.558578703725338, 1438.2872736274385, 119.36061780450159], [-32.395958925708968, 1435.403856705319, 124.78790075949998], [-36.333366303173122, 1434.0138870735752, 130.15557254216623], [-40.104983970406238, 1432.1619754731435, 135.72848741025098], [-43.853865404226873, 1430.1881776019234, 141.37805157654944], [-47.820236459128559, 1427.859578296863, 147.55447698316092], [-54.790441757587672, 1423.9093409935472, 158.29091514076796], [-59.815172096458745, 1419.7505892961387, 167.11702155362582], [-61.614322651703944, 1414.2011871719405, 173.641640374632]],\
            u5: [[-21.002503517355631, 1436.5106901399581, 98.865216603641855], [-24.425819943476291, 1436.7551118146434, 102.32818532687644], [-29.295133399139466, 1436.4759933645571, 107.77324738881049], [-33.668965401045178, 1433.5508493067964, 114.88025119571293], [-37.755534655167239, 1432.3640820557878, 120.23926527256963], [-41.28876481184507, 1430.4251585579148, 125.62902556604027], [-45.227472596920478, 1428.8001889063728, 131.19280886588385], [-48.509351798990274, 1426.1921081824175, 136.8678949649167], [-53.022005782427868, 1424.6054708440345, 143.01446570444477], [-59.647204730664747, 1420.1866456044011, 153.76975865173929], [-60.056621789995589, 1409.7593712444279, 162.84809451247244], [-64.455463773923455, 1407.7408723654371, 169.23063874525766]],\
            u6: [[-27.445365349358088, 1434.8725747321064, 94.228650006153217], [-29.97248621967384, 1433.8997827938949, 97.740596316939559], [-33.812904017922058, 1432.2232173331051, 103.24188810107722], [-39.057943555597149, 1430.4813481368813, 110.30127992967562], [-42.63686049219158, 1428.6050870499375, 115.68803748915369], [-46.566695248432737, 1427.2048322772132, 121.05612311979796], [-49.508687921521805, 1424.2261232608244, 126.67437745706771], [-54.663914661908635, 1424.1624248545081, 132.24708406707219], [-56.748335292136304, 1419.2777587837948, 138.52635911525547], [-60.261464090679638, 1410.6321170575502, 149.45172843398274], [-64.839518655714343, 1405.8666899208997, 158.30224592729948], [-66.996030632156376, 1400.8026564015645, 164.80733474709047]],\
            u7: [[-32.386014591723239, 1430.9942072007914, 89.591720417201998], [-35.081977601056821, 1430.2507368082067, 93.094439410811177], [-39.151480610647511, 1428.8853150882633, 98.583211560229884], [-44.161784016965207, 1426.8246270665284, 105.65543184948147], [-47.860500144921083, 1425.1110773494388, 111.03564231625673], [-51.137816251755602, 1422.8245711580541, 116.43938845545138], [-56.544966500035159, 1423.1940413856144, 121.9229205547162], [-56.739960324654803, 1416.3933501554409, 127.76670666331498], [-59.489251358579757, 1412.4117116672201, 134.00964617267894], [-63.490706973505276, 1404.4293158637995, 144.90832815821338], [-66.666845367501068, 1397.7598049181242, 153.83546115309485], [-70.312517513663252, 1394.7183500855815, 160.25916653807735]],\
            u8: [[-37.630222741557994, 1427.6002780925035, 84.9679543153038], [-40.070782172098966, 1426.50991832865, 88.484631257108973], [-44.627615496142283, 1425.8063890817123, 93.94677053272224], [-48.978687294820176, 1422.850332095386, 101.05501819743999], [-53.248566386025566, 1421.912536430576, 106.4040142893418], [-56.977960098867989, 1420.2400424517664, 111.78305413493216], [-57.193869145261068, 1413.5587641927325, 117.55029046462055], [-60.04253899372074, 1410.3622981336439, 123.24905169672856], [-61.986745037170714, 1405.2871924845986, 129.53598955037413], [-65.773488849632443, 1397.0131749172533, 140.44640565580605], [-70.868120227944445, 1392.9493628747123, 149.26869193782642], [-70.015293355764726, 1383.7980426146173, 155.93824280608084]],\
            u9: [[-45.078481505489364, 1422.4881712063036, 78.280570582006462], [-48.397749876939201, 1422.5912747192101, 81.749225589528251], [-50.450475385771384, 1418.4866639771731, 87.348215755512982], [-58.191114997107285, 1420.1343210537932, 94.271221646566133], [-58.466054347764057, 1413.7705946270971, 99.838543426025794], [-58.803626747239726, 1407.4913258786355, 105.40294820035308], [-62.138826245762544, 1405.0466707275018, 110.99971356505006], [-63.252435332768513, 1399.4936435759478, 116.79329683661321], [-65.411048239979834, 1394.7097455228102, 123.06851723543122], [-71.083370138496022, 1388.9967218140755, 133.87588544557127], [-67.073657758173866, 1372.5673818599716, 143.19572919778116], [-70.484253980722926, 1369.2066466957708, 149.63228161325341]],\
            u10: [[-50.480535741821718, 1418.6315892009297, 73.368959622534206], [-51.813034168308782, 1416.0362599811112, 76.946192716941596], [-60.747780223707885, 1421.2788157578914, 82.169076617201142], [-57.127588211567449, 1407.4961810679631, 89.712958300259132], [-60.308162419505813, 1405.0788905273707, 95.121485512289453], [-62.687958918755783, 1401.5733723947631, 100.57428159920491], [-63.701473966386871, 1395.9754033266195, 106.29792831555002], [-65.814072225518373, 1391.7792041704413, 112.03691627103022], [-69.04749170726673, 1388.4551093770876, 118.25339789038813], [-65.829356995320765, 1370.6670594744976, 129.5466345186376], [-71.187377099526188, 1366.9609822372411, 138.35452645971415], [-70.499020192464883, 1358.0330452322323, 145.01508895253642]],\
            u11: [[-54.066864569912198, 1416.1498329682902, 70.140626770972901], [-56.361108407543135, 1414.8607472340641, 73.665299941631943], [-57.978442660818182, 1410.1647876956924, 79.288084482851659], [-60.328733089919098, 1404.4912676470758, 86.505675966634243], [-61.982597413823719, 1400.0003983638139, 91.997638726327352], [-63.695354773365203, 1395.5889070695093, 97.486888874696362], [-65.543565526591223, 1391.1246224621941, 103.16491900464449], [-66.981602478688671, 1386.0122335298697, 108.94077211222297], [-67.507391536283308, 1379.0106326502164, 115.30522724617624], [-68.655514349339441, 1367.1528376595643, 126.35984546260704], [-69.560084545579457, 1357.3980807371197, 135.4111209279186], [-70.249130238519498, 1350.3409331868338, 141.99640759952217]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 116945.191;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Computes bending energy for a B-surface specified as JSON object.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome
  mobius::test_BSplineSurface::computeEnergy06(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C1,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 2,\
        V_degree: 2,\
        U_knots: [0, 0, 0, 0.16514958329080542, 0.24473993524656207, 0.32421011743689787, 0.4039309910430593, 0.48554141924154515, 0.56759568679667605, 0.65127518649812433, 0.74030763379806386, 0.83457599426777973, 1, 1, 1],\
        V_knots: [0, 0, 0, 0.11844778490480518, 0.19508647514820374, 0.26873139008876673, 0.34174681401897933, 0.41789830379100695, 0.50116954019801851, 0.57820377022250635, 0.6599648627773913, 0.77342401035789177, 1, 1, 1],\
        num_poles_in_U_axis: 12,\
        num_poles_in_V_axis: 12,\
        poles: {\
            u0: [[17.36366137433394, 1439.9437756670429, 123.86809157124523], [12.572077495318762, 1441.3778161961723, 127.81041551672091], [5.0078745479051321, 1443.0411867725393, 134.53148288029718], [-0.99887300859966111, 1444.6145868369972, 139.65946351210428], [-5.3238595919198719, 1443.9373185144218, 144.85159475816636], [-9.9164556377059636, 1443.5168664750242, 150.11747126083654], [-14.774890061828026, 1443.0094144631503, 155.74008000889722], [-19.565251192499389, 1442.413844799094, 161.36281327913085], [-24.23052014738353, 1441.7188544198618, 166.9339840881847], [-30.099472974753308, 1441.1501930636168, 173.68931663155601], [-37.684889221423454, 1436.6556584280363, 185.53548840772606], [-42.987875125772099, 1434.1256194010307, 193.30999708514409]],\
            u1: [[9.2630012722195758, 1441.3293237181408, 119.45932319752021], [2.7126911251707537, 1445.1520678521381, 123.30553177039137], [-2.5361245590050068, 1443.6706773574476, 130.15313634079445], [-6.9904677048676938, 1443.1356003499968, 135.36595674049113], [-11.692619559323372, 1442.9705982391511, 140.53747569388005], [-15.986579209114179, 1442.1445379771285, 145.81967284234747], [-20.716672638566571, 1441.4627731104406, 151.44929549743108], [-26.839630984912972, 1442.6771381876633, 156.9992015857182], [-30.206095010108445, 1440.2181097804823, 162.64135280941983], [-34.753830443506843, 1437.8549697670667, 169.46889062112766], [-42.609457668037116, 1433.7274359255391, 181.30029521647398], [-47.657975054733043, 1430.8517775281455, 189.08871074047471]],\
            u2: [[-2.7167736395802855, 1442.3251363011784, 112.50499293272145], [-5.9568025449112527, 1441.6518534644433, 116.532110223883], [-12.07150151844839, 1441.3465064350094, 123.33239378902095], [-16.657154435612977, 1440.9897744774757, 128.53803803639403], [-20.98305765460076, 1440.3137511302923, 133.73011918780483], [-25.66930956334771, 1440.0205025685132, 138.99087734526796], [-30.430521381593287, 1439.3810027255734, 144.61879936302793], [-33.844496361657953, 1436.9160241492823, 150.31675290495349], [-37.706975204146275, 1435.1306835147057, 155.9317966419201], [-42.181233612930171, 1432.6677469401325, 162.7633500140517], [-49.952749342604683, 1428.4259727903609, 174.59935134955936], [-55.255946453456232, 1425.8962206242184, 182.37384848442383]],\
            u3: [[-8.7054344309742895, 1440.3422009616354, 108.00545590944887], [-12.393307049461423, 1440.2771798603837, 112.00809829161456], [-18.297964771722693, 1439.6865546138586, 118.81986072842], [-22.715449412502998, 1439.1014163515322, 124.03469546600108], [-27.605828310216715, 1439.1920643807537, 129.19592770637144], [-31.34529214541659, 1437.612887402805, 134.5084283607315], [-35.017868719774654, 1435.4948021888961, 140.19584490245367], [-38.918130444155501, 1433.6902987077101, 145.86722260226435], [-42.583965766015147, 1431.6378766659043, 151.49301301743725], [-47.071413936660988, 1429.192854437797, 158.32384556171817], [-55.010292248794997, 1425.178392298604, 170.15070043864017], [-58.637753960298646, 1420.3726548003624, 178.01677744879458]],\
            u4: [[-14.971129526457375, 1438.6935786864694, 103.4734760359548], [-18.421381750717948, 1438.3058213512777, 107.48910450534993], [-24.446722697095527, 1437.8791081686877, 114.29427153656908], [-29.255894780449914, 1437.825960144447, 119.48770033669888], [-32.473572923196457, 1435.6447444983073, 124.74034660734863], [-36.195104635264478, 1434.0412120945307, 130.0538272622513], [-40.061057773658185, 1432.185771104459, 135.73067566676897], [-43.79692645806815, 1430.1579888479878, 141.41103753800974], [-47.468193586280535, 1428.1129442904726, 147.03653110193213], [-51.9132251318238, 1425.61031176386, 153.86968173846009], [-58.937695805415999, 1420.3539003445537, 165.74650950342519], [-61.595268867253417, 1414.2308592068043, 173.66559146986063]],\
            u5: [[-21.01476771649855, 1436.5885457987706, 98.889785248179152], [-24.885377789455426, 1436.7717188731378, 102.88244092641912], [-30.317045214109644, 1435.5386777774295, 109.72005254710227], [-33.844760701076588, 1433.7450542471902, 114.98351366577788], [-37.60927904767545, 1432.3065574595614, 120.2062748139368], [-41.212612418390208, 1430.5424879618606, 125.52621507419504], [-45.074596320681941, 1428.6816559517315, 131.2032803996822], [-48.648201831401238, 1426.4334877062749, 136.89251004397138], [-52.508383169226974, 1424.645026598793, 142.50767934085064], [-56.698329801312404, 1421.795937512454, 149.35477051033592], [-60.637345170793552, 1412.3488579138282, 161.40022013056037], [-64.4104379577347, 1407.7409166737079, 169.25833832112292]],\
            u6: [[-27.306232074114625, 1434.7462693441526, 94.262097671513246], [-30.293504291640492, 1433.7296921458756, 98.303028256800118], [-35.23910845476864, 1431.8364794895858, 105.16720350613885], [-39.029106440845403, 1430.3990882864023, 110.41633073978207], [-42.605451866654747, 1428.7050148678914, 115.64937564313611], [-46.323694793969786, 1427.0970156336975, 120.96303603196168], [-49.796790556431901, 1424.7079954009971, 126.66135431144227], [-54.185029843453997, 1423.5662634858943, 132.30606376497244], [-56.513750884129628, 1419.6977716203555, 138.00492822224399], [-58.894587997392925, 1414.3915483524504, 144.95088823712277], [-63.802320857073731, 1406.2601817234845, 156.94339690558536], [-67.057967069787949, 1400.9494440791445, 164.82979384036636]],\
            u7: [[-32.330191214754421, 1431.1193854645946, 89.67766479907155], [-35.388314412290462, 1430.1990381313253, 93.714723338738423], [-40.394777718358888, 1428.3884844179172, 100.57557260193225], [-44.10679930276001, 1426.8451855955868, 105.82896128946838], [-47.696971566535076, 1425.1698918008833, 111.06125054840675], [-51.185888293969349, 1423.2504215149945, 116.38744374210948], [-55.774769267160679, 1422.3768617627404, 122.02478373677954], [-56.970036077695802, 1416.8984317477386, 127.84399091907595], [-59.162063417701248, 1412.8442823745559, 133.5503257634175], [-61.742111046032107, 1407.8086270080437, 140.48539881241081], [-66.234464989054231, 1399.1130923595063, 152.50060817061197], [-70.04838589452811, 1394.5606039068318, 160.35649508169863]],\
            u8: [[-37.481807550542094, 1427.6710427357109, 85.088382206036428], [-40.481384677371693, 1426.6711780763565, 89.128640321158855], [-45.586522495233567, 1424.9946441739417, 95.984096967184328], [-49.058214766710549, 1423.1249298618498, 101.25061978586929], [-52.978977378637317, 1421.8986441764321, 106.4648420976828], [-56.351529391157243, 1419.8211272297035, 111.79739468803251], [-57.521981955233798, 1414.3046549263347, 117.62155370407915], [-59.821609655833655, 1410.32616886914, 123.38040694706862], [-61.755483120757219, 1405.9213946697812, 129.10085004483423], [-64.201065741219423, 1400.7031088081992, 136.04327168159151], [-69.565816226293293, 1393.1924639305983, 148.0108040816317], [-70.102887463802162, 1384.1893553008454, 156.04577265683474]],\
            u9: [[-42.748379511228343, 1424.0896873133727, 80.37357046869009], [-45.861644735896753, 1423.2442339311312, 84.407615465783451], [-50.596124123546687, 1421.0642714142036, 91.28332880199207], [-54.954986521013176, 1420.3995123680902, 96.501367277904279], [-56.799609812921993, 1416.3534123840698, 101.82905176285342], [-58.348722482068503, 1411.7992984751318, 107.26125633151017], [-60.454123799569736, 1407.5526744126521, 113.03431987611552], [-62.282338614204413, 1402.9339149481893, 118.81893609655546], [-64.212819094932513, 1398.5245323946338, 124.53956462280209], [-67.143914696110144, 1393.9656707017368, 131.45545270405717], [-69.134710376164549, 1381.872517362252, 143.60737361817647], [-70.312269015735907, 1373.7393193001556, 151.60733919921475]],\
            u10: [[-49.871990839393391, 1419.077815453531, 73.927113888607522], [-52.99732399340764, 1418.2487527438191, 77.960499366623409], [-58.385182650789574, 1416.9562105408577, 84.800505160900315], [-58.274574826985592, 1410.2210130055719, 90.262802680115428], [-60.190288239107005, 1406.2714676869989, 95.586602050299021], [-61.938372579067916, 1401.9875972809748, 101.00793270604153], [-63.723378995225666, 1397.3058125742664, 106.7985060109111], [-65.588936268497562, 1392.7377716708352, 112.58108144513466], [-68.071087390815379, 1389.0776686806864, 118.27156086277084], [-67.982243185842989, 1380.4171220169417, 125.35249034073821], [-69.098354032355488, 1367.1359709469523, 137.55221326942655], [-70.536011481405566, 1359.3560393226833, 145.53796430528982]],\
            u11: [[-54.066864569912227, 1416.1498329682915, 70.140626770972958], [-56.491454485379855, 1414.3690201594197, 74.212308258263832], [-58.620907504233564, 1408.6509084768056, 81.230387740149723], [-60.346000223347751, 1404.4089610760184, 86.59236319965629], [-61.966526717327966, 1400.0584926187582, 91.932294699745938], [-63.658568172972927, 1395.6985047166652, 97.356688130410248], [-65.527423298229806, 1391.1306034023476, 103.14267905650696], [-66.920306888375151, 1385.9205766758046, 108.9510863714502], [-67.479819792292858, 1379.6491447218375, 114.74663904130502], [-68.171425271896013, 1372.0486055242047, 121.78491650821451], [-69.425290359845661, 1358.9545523892868, 133.97711109068757], [-70.249130238519484, 1350.3409331868334, 141.99640759952212]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  const double eps = 1e-2;

  // Test.
  {
    const double energy_ref = 95566.646;
    const double energy = surf->ComputeBendingEnergy();
    //
    cf->ProgressNotifier.SendLogMessage( MobiusInfo(Normal) << "Bending energy is %1."
                                                            << energy );

    // Check.
    if ( abs(energy - energy_ref) > eps )
      return res.failure();
  }

  return res.success();
}

//-----------------------------------------------------------------------------

//! Inserts V knot to B-surface specified as JSON object. In this particular
//! case, knot insertion happened to distort the surface (this should not
//! happen).
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome mobius::test_BSplineSurface::insertKnot01(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 1,\
        U_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\
        V_knots: [0, 0, 1, 1],\
        num_poles_in_U_axis: 6,\
        num_poles_in_V_axis: 2,\
        poles: {\
            u0: [[241.87747035573125, 62.485923112593042, 0], [307.49011857707512, 49.837701768719491, 0]],\
            u1: [[245.29391602546553, 57.035146252318057, 0], [306.57174310419981, 45.021517271473421, 0]],\
            u2: [[250.62433050286035, 49.413132207145885, 25], [303.8174241480333, 37.906450425886014, 0]],\
            u3: [[260.43129359394032, 37.406082628166004, -22], [295.65540308364263, 29.098297811030434, -30]],\
            u4: [[266.65853554251112, 30.811365428505532, 0], [288.81855843279288, 26.561552469297354, 0]],\
            u5: [[271.12648221343875, 26.517543665952715, 0], [284.16996047430831, 25.727029831960614, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  std::string jsonRef =
  "{\n\
    entity: surface,\n\
    type: b-surface,\n\
    continuity: C0,\n\
    domain: {\n\
        U_min: 0,\n\
        U_max: 1,\n\
        V_min: 0,\n\
        V_max: 1\n\
    },\n\
    flags: {\n\
        is_U_rational: 0,\n\
        is_V_rational: 0,\n\
        is_U_periodic: 0,\n\
        is_V_periodic: 0,\n\
        is_U_closed: 0,\n\
        is_V_closed: 0\n\
    },\n\
    properties: {\n\
        U_degree: 3,\n\
        V_degree: 1,\n\
        U_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\n\
        V_knots: [0, 0, 0.5, 1, 1],\n\
        num_poles_in_U_axis: 6,\n\
        num_poles_in_V_axis: 3,\n\
        poles: {\n\
            u0: [[241.87747035573125, 62.485923112593042, 0], [274.68379446640319, 56.161812440656263, 0], [307.49011857707512, 49.837701768719491, 0]],\n\
            u1: [[245.29391602546553, 57.035146252318057, 0], [275.93282956483267, 51.028331761895743, 0], [306.57174310419981, 45.021517271473421, 0]],\n\
            u2: [[250.62433050286035, 49.413132207145885, 25], [277.22087732544685, 43.65979131651595, 12.5], [303.8174241480333, 37.906450425886014, 0]],\n\
            u3: [[260.43129359394032, 37.406082628166004, -22], [278.04334833879147, 33.252190219598219, -26], [295.65540308364263, 29.098297811030434, -30]],\n\
            u4: [[266.65853554251112, 30.811365428505532, 0], [277.738546987652, 28.686458948901443, 0], [288.81855843279288, 26.561552469297354, 0]],\n\
            u5: [[271.12648221343875, 26.517543665952715, 0], [277.6482213438735, 26.122286748956665, 0], [284.16996047430831, 25.727029831960614, 0]]\n\
        }\n\
    }\n}";

  // Insert knot.
  if ( !surf->InsertKnot_V(0.5, 1) )
    return res.failure();

  // Dump to JSON after modification.
  std::string jsonRes = surf->DumpJSON();
  //
  if ( jsonRes != jsonRef )
    return res.failure();

  return res.success();
}

//-----------------------------------------------------------------------------

//! Flips parameterization of a B-surface.
//!
//! \param[in] funcID function ID.
//! \return true in case of success, false -- otherwise.
mobius::outcome mobius::test_BSplineSurface::exchangeUV01(const int funcID)
{
  outcome res( DescriptionFn(), funcID );

  // Access common facilities.
  ptr<test_CommonFacilities> cf = test_CommonFacilities::Instance();

  /* =======================
   *  Prepare input surface
   * ======================= */

  // JSON definition.
  std::string json =
  "{\
    entity: surface,\
    type: b-surface,\
    continuity: C2,\
    domain: {\
        U_min: 0,\
        U_max: 1,\
        V_min: 0,\
        V_max: 1\
    },\
    flags: {\
        is_U_rational: 0,\
        is_V_rational: 0,\
        is_U_periodic: 0,\
        is_V_periodic: 0,\
        is_U_closed: 0,\
        is_V_closed: 0\
    },\
    properties: {\
        U_degree: 3,\
        V_degree: 1,\
        U_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\
        V_knots: [0, 0, 1, 1],\
        num_poles_in_U_axis: 6,\
        num_poles_in_V_axis: 2,\
        poles: {\
            u0: [[241.87747035573125, 62.485923112593042, 0], [307.49011857707512, 49.837701768719491, 0]],\
            u1: [[245.29391602546553, 57.035146252318057, 0], [306.57174310419981, 45.021517271473421, 0]],\
            u2: [[250.62433050286035, 49.413132207145885, 25], [303.8174241480333, 37.906450425886014, 0]],\
            u3: [[260.43129359394032, 37.406082628166004, -22], [295.65540308364263, 29.098297811030434, -30]],\
            u4: [[266.65853554251112, 30.811365428505532, 0], [288.81855843279288, 26.561552469297354, 0]],\
            u5: [[271.12648221343875, 26.517543665952715, 0], [284.16996047430831, 25.727029831960614, 0]]\
        }\
    }\
  }";

  // Construct B-surface.
  core_Ptr<bsurf> surf = bsurf::Instance(json);
  //
  if ( surf.IsNull() )
    return res.failure();

  /* ==============
   *  Perform test
   * ============== */

  std::string jsonRef =
  "{\n\
    entity: surface,\n\
    type: b-surface,\n\
    continuity: C2,\n\
    domain: {\n\
        U_min: 0,\n\
        U_max: 1,\n\
        V_min: 0,\n\
        V_max: 1\n\
    },\n\
    flags: {\n\
        is_U_rational: 0,\n\
        is_V_rational: 0,\n\
        is_U_periodic: 0,\n\
        is_V_periodic: 0,\n\
        is_U_closed: 0,\n\
        is_V_closed: 0\n\
    },\n\
    properties: {\n\
        U_degree: 1,\n\
        V_degree: 3,\n\
        U_knots: [0, 0, 1, 1],\n\
        V_knots: [0, 0, 0, 0, 0.41551883124182798, 0.59974028777161115, 1, 1, 1, 1],\n\
        num_poles_in_U_axis: 2,\n\
        num_poles_in_V_axis: 6,\n\
        poles: {\n\
            u0: [[241.87747035573125, 62.485923112593042, 0], [245.29391602546553, 57.035146252318057, 0], [250.62433050286035, 49.413132207145885, 25], [260.43129359394032, 37.406082628166004, -22], [266.65853554251112, 30.811365428505532, 0], [271.12648221343875, 26.517543665952715, 0]],\n\
            u1: [[307.49011857707512, 49.837701768719491, 0], [306.57174310419981, 45.021517271473421, 0], [303.8174241480333, 37.906450425886014, 0], [295.65540308364263, 29.098297811030434, -30], [288.81855843279288, 26.561552469297354, 0], [284.16996047430831, 25.727029831960614, 0]]\n\
        }\n\
    }\n\}";

#if defined FILE_DEBUG
  // Dump before modification.
  {
    core_FileDumper dumper("C:/users/ssv/desktop/before.json");
    //
    dumper.Dump(jsonRef);
  }
#endif

  // Flip parameterization.
  surf->ExchangeUV();

  // Dump to JSON after modification.
  std::string jsonRes = surf->DumpJSON();

#if defined FILE_DEBUG
  // Dump after modification.
  {
    core_FileDumper dumper("C:/users/ssv/desktop/after.json");
    //
    dumper.Dump(jsonRes);
  }
#endif

  // Verify.
  if ( jsonRes != jsonRef )
    return res.failure();

  return res.success();
}
